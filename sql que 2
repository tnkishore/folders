--Data Wrangling

--Part A. Data Gathering and Assessment

--Uploaded all the GCRM and NDMS tables from the postgres server

--Q1. Prepping s_per_comm_addr with two seperate columns for phone and email
--Creating per_comm_addr for email
create table gcrm.s_per_comm_addr_em1 as select distinct a.per_id, a.addr as email from gcrm.s_per_comm_addr as a where a.comm_medium_cd='Email';

alter table gcrm.s_per_comm_addr_ph1 rename column addr to phone;

--creating per_comm_addr for both phone and email, 27079343
--22449017
select count(*) from gcrm.s_per_comm_addr_ph1 as a;
--20075685
select count(distinct a.per_id) from gcrm.s_per_comm_addr_ph1 as a;
--15830002
select count(*) from gcrm.s_per_comm_addr_em1 as a;
--14380677
select count(distinct a.per_id) from gcrm.s_per_comm_addr_em1 as a;

--Q1a. 22957844
create table gcrm.s_per_comm_ph_email1 as select distinct a.per_id from gcrm.s_per_comm_addr as a;
--Q1b. 25331176
create table gcrm.s_per_comm_ph_email2 as select distinct a.per_id, b.phone from gcrm.s_per_comm_ph_email1 as a left outer join gcrm.s_per_comm_addr_ph1 as b on a.per_id = b.per_id;
--Q1c. 28352579
create table gcrm.s_per_comm_ph_email3 as select distinct a.per_id, a.phone, b.email from gcrm.s_per_comm_ph_email2 as a left outer join gcrm.s_per_comm_addr_em1 as b on a.per_id = b.per_id;

--28352579, 25299333, 19294526
select count(*), count(a.phone), count(a.email) from gcrm.s_per_comm_ph_email3 as a;
--0
select count(*) from gcrm.s_per_comm_ph_email3 as a where a.email is null and a.phone is null;
--16241280
select count(*) from gcrm.s_per_comm_ph_email3 as a where a.phone is not null and a.email is not null;

--assessing s_asset_con
--12369495, 12369495, 12369495, 0
select count(*), count(a.contact_id), count(a.asset_id), count(a.src_asset_id) from gcrm.s_asset_con as a;
--12369495, 11555674, 5814486, 0
select count(*), count(distinct a.contact_id), count(distinct a.asset_id), count(distinct a.src_asset_id) from gcrm.s_asset_con as a;

--To find the number of dealers till date, 2430
select
	count(distinct a.ou_num)
from
	gcrm.s_org_ext a,
	gcrm.s_org_ext b
where
	a.row_id = b.par_divn_id
	and b.divn_type_cd is not null;


--A. Data Gathering and Preprocessing: SMS Campaigns
--Q2. Creating a table for month, year and mobile numbers contacted for each SMS campaign using name of the flat files. Here name of the flat file corresponds to the respective SMS campaign.
create table gcrm.sms_contacts (
	sms_year varchar(40) NULL,
	sms_month varchar(20) NULL,
	sms_filename varchar(100) NULL,
	sms_mobile varchar(40) NULL
);

--Q2a. Loading all 101 flat files into gcrm.sms_contact
copy gcrm.sms_contacts from 'D:/SMS_Contacts/file1.csv' delimiter ',' quote '"' csv header;
copy gcrm.sms_contacts from 'D:/SMS_Contacts/file101.csv' delimiter ',' quote '"' csv header;

--Q3. Creating a table containing list of distinct mobile numbers contacted for SMS campaigns, 6549074
create table gcrm.sms_contacts_dist as
select
	distinct b.sms_mobile
from
	gcrm.sms_contacts as b; 

--Q4. Creating a table for per_ids and phones from s_per_comm_addr, 22449017
create table s_per_comm_addr_ph1 as
select
	distinct a.per_id,
	a.phone
from
	s_per_comm_addr as a
where
	a.comm_medium_cd = 'Phone';


--Q5. Obtaining the contact details like per_ids of those mobile numbers contacted for SMS campaigns from s_per_comm_addr_ph1, 52323781
create table gcrm.sms_contacts_2 as
select
	distinct a.*,
	b.per_id
from
	gcrm.sms_contacts as a
left outer join s_per_comm_addr_ph1 as b on
	a.sms_mobile = b.phone;

--Q6. Obtaining asset_ids of those mobile numbers contacted for SMS campaigns from s_asset_con using per_id, 65740265
create table gcrm.sms_contacts_3 as
select
	distinct a.*,
	b.asset_id
from
	gcrm.sms_contacts_2 as a
left outer join gcrm.s_asset_con as b on
	a.per_id = b.contact_id;

--Q7. Table for list of all 101 flat files
create table gcrm.sms_comb_file_names (
    sms_filename varchar(300) NULL,
	combinedv3_SMScamp_name varchar(100) NULL,    
    target_base_desc varchar(100) NULL,	
	sms_campaign_name varchar(300) NULL,
	sms_year varchar(4) null.
	sms_month varchar(4) NULL
);

--Q7a
copy gcrm.sms_comb_file_names from 'D:\Comparison - Combined and SMS File Names.csv' delimiter ',' quote '"' csv header;

--Q7b Removing campaign 'All_Mumbai_Customers_2005_to_July17_June2018' as it in not in the given list of campaigns
delete from	gcrm.sms_comb_file_names where sms_campaign_name = 'All_Mumbai_Customers_2005_to_July17_June2018';

--Q7c Applying corrections to sms_comb_file_names
update gcrm.sms_comb_file_names set sms_year = '2017', sms_month = 'July' where sms_campaign_name = 'ExtendedWarrantySMS_January2017-DND Number Not Available';
update gcrm.sms_comb_file_names set sms_campaign_name = 'FCCC_AllRegionsExceptSRO4_3rdYear&AboveCustomers_April2017' where sms_campaign_name = 'FCCC_AllRegionsExceptSRO4_3rdYear&AboveCustomers_March2017' and sms_year = '2017' and sms_month = 'April';
update gcrm.sms_comb_file_names set sms_campaign_name = 'FCCC_AllRegionsExceptSRO4_3rdYear&AboveCustomers_April2017' where sms_campaign_name = 'FCCC_AllRegionsExceptSRO4_1st&2ndYearCustomer_March2017' and sms_year = '2017' and sms_month = 'April';
update gcrm.sms_comb_file_names set sms_campaign_name = 'All_Mumbai_Customers_2005_to_July17_September2017' where sms_campaign_name = 'All_Mumbai_Customers_2005_to_July17_August2017' and sms_year = '2017' and sms_month = 'September';
update gcrm.sms_comb_file_names set sms_campaign_name = 'Monsoon Car Care Clinic_2014_to_July2017' where sms_campaign_name like 'Monsoon Car Care Clinic_2014_to_July%';
update gcrm.sms_comb_file_names set sms_campaign_name = 'FCC for SRO3 Customers_2013 to 2017_April2018' where sms_campaign_name like 'FCC for SRO3 Customers_2013 to 2017_April%';
alter table gcrm.sms_comb_file_names add column camp_id varchar(15);
alter table gcrm.sms_comb_file_names add column prog_start_dt timestamp;
alter table gcrm.sms_comb_file_names add column prog_end_dt timestamp;

--Q8. Now bringing in combinedv3_smscamp_name and sms_campaign_name from gcrm.sms_comb_file_names
create table gcrm.sms_contacts_4 as
select
	distinct a.*,
	b.combinedv3_smscamp_name,
	b.sms_campaign_name
from
	gcrm.sms_contacts_3 as a
left outer join gcrm.sms_comb_file_names as b on
	a.sms_filename = b.sms_filename
	and a.sms_month = b.sms_month
	and a.sms_year = b.sms_year;

--Q9. Creating source table for all 49 finalised campaigns
create table analysis.our_s_src (
       new_camp_id varchar(20) NULL,
       new_campaign_disp_name varchar(100) NULL,
       channel_clubbed varchar(20) NULL,
       prog_start_dt_new timestamp NULL,
       prog_end_dt_new timestamp NULL,
       ageofvehicle_targeted varchar(20) NULL,
       models_targeted varchar(50) NULL,
       campaign_type varchar(20) NULL,
       camp_sub_type varchar(20) NULL,
       frequency varchar(20) NULL,
       region varchar(75) null,
       SMS_sent numeric (15,2) Null,
       Budget numeric (15,2) null
);

--Q9a
copy gcrm.our_s_src from 'D:/Campaigns List V0 2- Jatin -25thNov V2 - dashboard.csv' delimiter ',' quote '"' csv header;

--Q10. Bringing in additional columns like new_camp_id, new_campaign_disp_name, channel_clubbed, campaign_type, prog_start_dt_new and prog_end_dt_new from source table
create table gcrm.sms_contacts_5 as
select
	a.*,
	b.old_camp_id,
	b.new_camp_id,
	b.channel_clubbed,
	b.new_campaign_disp_name,
	b.region,
	b.campaign_type,
	b.camp_sub_cat,
	b.prog_start_dt_new,
	b.prog_end_dt_new
from
	gcrm.sms_contacts_4 as a
left outer join gcrm.our_s_src as b on
	a.sms_campaign_name = b.old_campaign_name;

--Q10a. Keeping only the required columns
create table gcrm.sms_contacts_6 as
select
	a.new_camp_id,
	a.old_camp_id,
	a.channel_clubbed,
	a.per_id,
	a.asset_id,
	a.new_campaign_disp_name,
	a.sms_campaign_name,
	a.campaign_type,
	a.sms_mobile,
	a.sms_month,
	a.sms_year,
	a.prog_start_dt_new,
	a.prog_end_dt_new
from
	gcrm.sms_contacts_5 as a;

--57253923, 7888733
select count(a.per_id), count(distinct a.per_id) from gcrm.sms_contacts_6 as a;

--Q11a. Bringing in VIN from s_asset using asset_id
create table gcrm.sms_cont_vin_7 as
select
	a.*,
	b.asset_num
from
	gcrm.sms_contacts_6 as a
left outer join gcrm.s_asset as b on
	a.asset_id = b.row_id;

--Q11b
create table gcrm.sms_only1 as select a.old_camp_id, a.new_camp_id, a.new_campaign_disp_name, a.per_id as contact_id, a.asset_id, a.asset_num as vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_cont_vin_7 as a where a.channel_clubbed = 'SMS only';
create table gcrm.sms_only1_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.sms_only1 as a group by 1, 2;

--Removing contact ids that are null
--Q11c
create table gcrm.sms_only3 as select distinct a.new_camp_id, a.new_campaign_disp_name, a.contact_id, a.asset_id, a.vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_only1 as a where a.contact_id is not null;
create table gcrm.sms_only3_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.sms_only2 as a group by 1, 2;

--Part B. Data Gathering Preprocessing: Email Campaigns
--Initially there were 66 email campaigns (52 + 14)
--Q12. Five email campaigns with con_per_ids from s_camp_con
--6383270
create table camp_con_5_1 as
select
	distinct a.src_id as camp_id,
	a.con_per_id,
	a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-17OVJ5H','1-1EDYJB6','1-1F2I7QH','1-1FGSQR5','1-1FZ04OB');
	
--Q13. Asset ids from s_asset_con for con_per_ids of those five email campaigns
--7132506
create table gcrm.camp_con_5_2 as
select
	a.camp_id,
	a.con_per_id,
	b.contact_id,
	b.asset_id
from
	gcrm.camp_con_5_1 as a
left outer join gcrm.s_asset_con as b on
	a.con_per_id = b.contact_id;

--Analysis of prospects
--Q14. Creating a table with list of distinct prsp_con_per_ids for the 27 campaigns with only prospects
--7447268
create table gcrm.dist_prosp_27 as
select
	distinct a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-ANFRFX','1-AXH9AX','1-CQV09V','1-GDE874','1-HH7IWN','1-BR7XJ4','1-FPG6T5','1-FCGO5Q','1-G5QMCP','1-I7S8MD','1-KGWAX9','1-KGWBGZ','1-HLQOFL','1-P3CLGG','1-BR7XQF','1-J39WPC','1-EIEJ79','1-F29BMX','1-JEQ4XN','1-BR7Y3X','1-GDE84T','1-ED6724','1-P3CLPH','1-QAA78U','1-U7XQH9','1-DG2D0E','1-D8FDZP');

--Q15. Creating a table for contact details of the above list of prsp_con_per_ids by merging it with s_prsp_contact
--7447268
create table gcrm.prosp_cont_27 as
select
	a.prsp_con_per_id,
	b.last_name,
	b.email_addr,
	b.full_name,
	b.fst_name,
	b.city
from
	dist_prosp_27 as a
left outer join s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--43
select count(*) from gcrm.prosp_cont_27 as a where a.last_name is null or a.email_addr is null;

--Q16. Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using email_addr and last_name
--7513570
create table gcrm.prosp_s_cont_27 as
select
	a.prsp_con_per_id,
	b.row_id,
	a.email_addr as prosp_email,
	b.email_addr as email,
	a.last_name as prosp_last_name,
	b.last_name
from
	prosp_cont_27 as a
left outer join s_contact as b on
	(a.email_addr = b.email_addr and a.last_name = b.last_name);

--some checks
--236800
select count(*) from gcrm.prosp_s_cont_27 as a where a.email = a.prosp_email and a.last_name = a.prosp_last_name;
--236800
select count(*) from gcrm.prosp_s_cont_27 as a where a.email = a.prosp_email;

--Q17. To identify if the above list of prospects with entries in s_contact also have asset_nums(VIN) in s_asset
--7514224
create table gcrm.prosp_asset_27 as
select
	a.row_id,
	b.pr_con_id,
	b.asset_num,
	b.pr_asset_id
from
	prosp_s_cont_27 as a
left outer join s_asset as b on
	a.row_id = b.pr_con_id;

--some checks
--45540
select count(*) from gcrm.prosp_asset_27 as a where a.asset_num is not null;
--36826
select count(distinct a.asset_num) from gcrm.prosp_asset_27 as a;
--36280
select count(distinct a.pr_con_id) from gcrm.prosp_asset_27 as a;
--211778
select count(distinct a.row_id) from gcrm.prosp_asset_27 as a;
--45540
select count(*) from gcrm.prosp_asset_27 as a where a.row_id = a.pr_con_id;

--Q18. Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using only email_addr, not last_name
--Below query takes more than 6500 secs(doesn't end)
create table prosp_s_cont_27_email as
select
	a.prsp_con_per_id,
	b.row_id,
	a.email_addr as prosp_email,
	b.email_addr as email,
	a.last_name as prosp_last_name,
	b.last_name
from
	prosp_cont_27 as a
left outer join s_contact as b on
	(a.email_addr = b.email_addr);

--Q19. prsp_con_per_ids for 27 email campaigns with only prospects
--7522599
create table prosp_asset_con_27 as
select
	a.row_id,
	b.contact_id,
	b.asset_id
from
	prosp_s_cont_27 as a
left outer join s_asset_con as b on
	a.row_id = b.contact_id;

--Q20. Asset ids from s_asset_con for con_per_ids of those five email campaigns
--7522599
create table prosp_ast_con_ast_27 as
select
	a.row_id,
	a.contact_id,
	a.asset_id,
	b.row_id as ast_row_id,
	b.pr_con_id,
	b.asset_num,
	b.pr_asset_id
from
	prosp_asset_con_27 as a
left outer join s_asset as b on
	a.asset_id = b.row_id;

--Q21. Creating a table for camp_id and prsp_con_per_ids for the 27 campaigns with only prospects
--9853942
create table gcrm.camp_con_27_1 as
select distinct
	a.src_id as camp_id,
	a.con_per_id,
	a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-154L44P','1-ANFRFX','1-AXH9AX','1-BR7XJ4','1-BR7XQF','1-BR7Y3X','1-CQV09V','1-D8FDZP','1-DG2D0E','1-ED6724','1-EIEJ79','1-F29BMX','1-FCGO5Q','1-FPG6T5','1-GDE84T','1-GDE874','1-HH7IWN','1-HLQOFL','1-I7S8MD','1-J39WPC','1-JEQ4XN','1-KGWAX9','1-KGWBGZ','1-P3CLGG','1-P3CLPH','1-QAA78U','1-T1YOOF');

--Q22. Joining those 27 campaigns and its prospects with s_prsp_contact for prospects' row_id, email, last name and phone
--9853942
create table gcrm.camp_con_27_2 as
select
	a.*,
	b.row_id as prsp_row_id,
	b.email_addr as prsp_email,
	b.last_name as prsp_l_name,
	b.cell_ph_num as prsp_phone
from
	gcrm.camp_con_27_1 as a
left outer join s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--Q23. Creating a table to store counts of records, prospects and distinct prospects for each camp_id
create table gcrm.camp_con_27_2_count as
select
	a.camp_id,
	count(*),
	count(a.prsp_row_id),
	count(distinct a.prsp_row_id)
from
	gcrm.camp_con_27_2 as a
group by 1;

--Check
select
	camp_id,
	prsp_email,
	prsp_l_name,
	count(*)
from
	camp_con_27_2
group by 1, 2, 3
having count(*) > 500;

--Q24. Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using both email_addr and last_name
--10524063
create table camp_con_27_3 as
select
	a.*,
	b.row_id as cont_row_id,
	b.cell_ph_num
from
	camp_con_27_2 as a
left outer join s_contact as b on
	lower(trim(a.prsp_email)) = lower(trim(b.email_addr))
	and lower(trim(a.prsp_l_name)) = lower(trim(b.last_name));

--Q25. Grabbing the asset_ids of those prospects who had entries in s_contact
--10678148
create table gcrm.camp_con_27_4 as
select
	a.*,
	b.asset_id,
	b.row_id as asset_con_row_id
from
	gcrm.camp_con_27_3 as a
left outer join gcrm.s_asset_con b on
a.cont_row_id = b.contact_id;

--Q26. Creating a table to store counts of records, asset_ids and distinct asset_ids for each of those 27 campaigns
create table gcrm.camp_con_27_4_count as
select
	a.camp_id,
	count(*),
	count(a.asset_id),
	count(distinct a.asset_id)
from
	gcrm.camp_con_27_4 as a
group by 1;

--Q27. Pulling out src, con_per & prsp_con_per from camp_con for 14 more campaigns (small camp_con for only 14 campaigns)
--37,34,134
create table gcrm.a_camp_con_14 as
select distinct
	src_id,
	con_per_id,
	prsp_con_per_id
from
	gcrm.s_camp_con
where
	src_id in ('1-CQV092','1-G5QMCP','1-P3CLFK','1-P3CLFN','1-BR7XPG','1-BR7XQ9','1-ED671B','1-19W84A2','1-ZPNIVN','1-U7XQH9','1-VYE9WV','1-RUISW7','1-1163Q16','1-GMAW9H');

--Q28. Out of those 14 campaigns, three only have contacts
--41,41,176
create table gcrm.a_camp_con_14_contact as
select
	a.src_id,
	a.con_per_id,
	b.asset_id
from
	gcrm.a_camp_con_14 as a
left outer join gcrm.s_asset_con as b on
	b.contact_id = a.con_per_id
where
	a.src_id in ('1-1163Q16','1-RUISW7','1-VYE9WV');

--Q29a. Combining 5 and 3 email campaigns with contacts
--1-17OVJ5H,1-1EDYJB6,1-1F2I7QH,1-1FGSQR5,1-1FZ04OB,1-1163Q16,1-RUISW7 and 1-VYE9WV
create table gcrm.camp_con_8 as
select * from gcrm.camp_con_5_2;	

--Q29b. 1,10,05,402
insert into	gcrm.camp_con_8(camp_id, con_per_id, asset_id)
select a.src_id, a.con_per_id, a.asset_id
from gcrm.a_camp_con_14_contact as a
where a.asset_id is not null or a.con_per_id is not null;

--Q30. Out of eight email campaigns with contacts, 1-1163Q16 has very less number of VINs, hence ignoring 1-1163Q16
--1,09,94,265
create table gcrm.camp_con_8_2 as
select	*
from
	gcrm.camp_con_8
where
	camp_id in ('1-1FGSQR5','1-1FZ04OB','1-AXH9AX','1-HLQOFL','1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-G5QMCP','1-T1YOOF','1-VYE9WV','1-HH7IWN','1-ANFRFX','1-RUISW7','1-U7XQH9','1-P3CLPH','1-154L44P','1-1EDYJB6');

--Q31. Grabbing row_id from s_camp_con
--1,11,24,777
create table gcrm.camp_con_8_3 as 
select
	a.camp_id,
	a.con_per_id,
	b.row_id as camp_con_row_id
from
	gcrm.camp_con_8_2 as a,
	gcrm.s_camp_con as b
where
	a.camp_id = b.src_id
	and a.con_per_id = b.con_per_id;

--Q32. Obtaining last name, email address and row id of all prospects of those 14 campaigns
--1,25,368
create table gcrm.a_camp_con_14_prsp_con as
select
	distinct a.src_id,
	a.prsp_con_per_id,
	b.last_name,
	b.email_addr,
	b.row_id
from
	gcrm.a_camp_con_14 as a
left outer join gcrm.s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--Q33. Only two email campaigns had considerable number of VINs, obtaining row_ids from s_contact for those two using last name and email address
--1,30,578
create table gcrm.a_CAMP_con_14_prsp_con_contact as
select distinct
	a.src_id,
	a.prsp_con_per_id,
	a.last_name,
	a.email_addr,
	b.row_id
from
	gcrm.a_camp_con_14_prsp_con as a
left outer join gcrm.s_contact as b on
	b.email_addr = a.email_addr
	and b.last_name = a.last_name
	where a.src_id in ('1-G5QMCP', '1-U7XQH9');

--Q34. Getting the asset ids for those prospects
--1,31,376
create table gcrm.a_CAMP_con_14_prsp_con_contact_end as
select
	distinct a.src_id,
	a.prsp_con_per_id,
	a.row_id,
	b.asset_id
from
	gcrm.a_CAMP_con_14_prsp_con_contact as a
left outer join gcrm.s_asset_con as b on
	a.row_id = b.contact_id;

--Q35. Keeping only the valid 17 email and both campaigns
create table gcrm.fact_table_RO as 
select distinct a.row_id , a.src_id , a.asset_id 
from  a_camp_con_14_prsp_con_contact_end a
where src_id in ('1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-1EDYJB6','1-1FGSQR5','1-1FZ04OB','1-VYE9WV','1-RUISW7','1-ANFRFX','1-P3CLPH','1-G5QMCP','1-U7XQH9','1-154L44P','1-HLQOFL','1-AXH9AX','1-T1YOOF','1-HH7IWN');

--Exclusion List: Contacts with multiple VINs(greater than 3)
--Q36a. Creating list of contact_ids with more than three VINs, leaving car leasing companies (list given by business)
create table con_vin_disc as
select contact_id, count(*) as asst_ct from gcrm.s_asset_con
group by 1
having count(*) >3
order by count(*) desc;

--Q36b
create table g3_ocmv_con as
select
	distinct a.*,
	b.last_name,
	b.con_cd,
	b.sex_mf,
	b.email_addr,
	b.cell_ph_num
from
	gcrm.con_vin_disc as a
inner join gcrm.s_contact as b on
	a.contact_id = b.row_id;
              
--Q36c
create table g3_fleet20 as
select
	contact_id
from
	g3_ocmv_con as a
where
	lower(trim(a.last_name)) like '%clix%'
	or lower(trim(a.last_name)) like '%ge capital%'
	or lower(trim(a.last_name)) like '%good morning lease%'
	or lower(trim(a.last_name)) like '%lease plan%'
	or lower(trim(a.last_name)) like '%lnt finance%'
	or lower(trim(a.last_name)) like '%magma%'
	or lower(trim(a.last_name)) like '%orix%'
	or lower(trim(a.last_name)) like '%smas leasing%'
	or lower(trim(a.last_name)) like '%sumitomo leasing%'
	or lower(trim(a.last_name)) like '%sundaram lease%'
	or lower(trim(a.last_name)) like '%tata capital%'
	or lower(trim(a.last_name)) like '%ald / hyundai leasing%'
	or lower(trim(a.last_name)) like '%arval%'
	or lower(trim(a.last_name)) like '%avis lease%'
	or lower(trim(a.last_name)) like '%bmw leasing%'
	or lower(trim(a.last_name)) like '%bnp lease%'
	or lower(trim(a.last_name)) like '%tranzlease holding (i) pvt ltd.%'
	or lower(trim(a.last_name)) like '%ola fleet%'
	or lower(trim(a.last_name)) like '%carzonrent%'
	or lower(trim(a.last_name)) like '%zoomcar%';

--Q36d. 22,937 contacts
create table g3_ocmv_exclutionlist as
select a.contact_id from g3_ocmv_con as a 
where a.contact_id not in (select distinct b.contact_id from g3_fleet20 as b);

--Q36e. 22,937
create table gcrm.g3_ocmv_exclutionlist (
	contact_id varchar(15) null
);
--Q36f
copy gcrm.g3_ocmv_exclutionlist from 'D:/g3_ocmv_exclutionlist_201911221103.csv' delimiter ',' quote '"' csv header;

--Q37. Removing those contacts in ocmv_exclutionlist
--12266232
create table gcrm.fact_table_RO_1  as
select * from gcrm.fact_table_RO
where row_id not in (select * from ndms.g3_ocmv_exclutionlist);

--Q38. Getting camp names, channel name, prog start and end dates for 17 campaigns
--1,22,66,232
create table gcrm.fact_table_RO_2 as
select
	distinct src.row_id as camp_id,
	camp.row_id as contact_id,
	veh.asset_num as vin,
	camp.asset_id,
	date(src.prog_start_dt) as prog_start_dt,
	date(src.prog_end_dt) as prog_end_dt,
	src."name" as camp_name,
	(case
		when src.prog_start_dt is not null then 'EMAIL'
	end )as channel_name
from
	gcrm.fact_table_RO_1 as camp
left outer join s_src as src on
	src.row_id = camp.src_id
left outer join s_asset as veh on
	veh.row_id = camp.asset_id;

--Q38. Removing contacts in g3_ocmv_exclutionlist
--1,21,40,803
create table gcrm.final_fact_email as
select
	*
from
	gcrm.fact_table_ro_2 as a
where
	a.contact_id not in (
	select
		*
	from
		gcrm.g3_ocmv_exclutionlist);

--Q39. Getting new campaign display names, channel clubbed, new prog start and end dates for 17 campaigns from source table
--1,17,28,921
create table most_final_fact_email as
select 
	a.*,
	b.old_camp_id ,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed
from
	gcrm.final_fact_email as a
left outer join gcrm.our_s_src as b on
	a.camp_id = b.old_camp_id;

--Q39a. Email Only
create table gcrm.really_again as
select * from gcrm.most_final_fact_email where channel_clubbed='Email only';
	
--Part C. Now combining all three channels types(SMS, Email and Both)
--Q40a. Only Both - 25500426, 5438066 (Email both), 20062360 (SMS Both)
create table gcrm.both_details as
select
	b.old_camp_id,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.contact_id,
	b.asset_id,
	b.vin,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed,
from
	gcrm.most_final_fact_email as b
where
	b.channel_clubbed = 'Email only';
union all
select
	a.old_camp_id,
	a.new_camp_id,
	a.new_campaign_disp_name,
	a.per_id as contact_id,
	a.asset_id,
	a.asset_num as vin,
	a.prog_start_dt_new,
	a.prog_end_dt_new,
	a.channel_clubbed,
	'SMS' as channel_name
from
	gcrm.sms_cont_vin_7 as a
where
	a.channel_clubbed = 'Both';

--Q40b. Creating a table to store campaign-wise counts and distinct counts of contact_ids, asset_ids and vins for all 49 campaigns (32 SMS only + 9 Both + 8 Email only)
create table gcrm.both_details_count as select a.new_camp_id, a.new_campaign_disp_name, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.both_details as a group by 1, 2;

--Q40c. Both with contact ids not null 
--18264778
create table gcrm.both_details2 as select distinct b.new_camp_id, b.new_campaign_disp_name,	b.contact_id, b.asset_id, b.vin, b.prog_start_dt_new, b.prog_end_dt_new, b.channel_clubbed from	gcrm.both_details as b where CONTACT_ID is not null;

--Part D - Bringing in RO details for all three types
--Q41. All three types with contact ids not null, 56160210
create table gcrm.all_three1 as
select a.new_camp_id, a.new_campaign_disp_name, a.contact_id, a.asset_id, a.vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.both_details2 as a
union all
select b.new_camp_id, b.new_campaign_disp_name, b.contact_id, b.asset_id, b.vin, b.prog_start_dt_new, b.prog_end_dt_new, b.channel_clubbed from gcrm.sms_only3 as b
union all
select c.new_camp_id, c.new_campaign_disp_name, c.contact_id, c.asset_id, c.vin, c.prog_start_dt_new, c.prog_end_dt_new, c.channel_clubbed from gcrm.really_again as c;

--Q41a. Creating a table to store campaign-wise counts and distinct counts of contact_ids, asset_ids and vins for all 49 campaigns (32 SMS only + 9 Both + 8 Email only)
create table gcrm.all_three1_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from gcrm.all_three1 as a group by 1, 2;

--Q42. All three where asset ids and vins are not null, vin null check only is enough, 43978714
create table gcrm.all_three2 as select * from gcrm.all_three1 as a where a.vin is not null;
--Q42a
create table gcrm.all_three2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from gcrm.all_three2 as a group by 1, 2;

--Q43. All three, excluding contact_ids with more than three VINs(g3_ocmv_exclutionlist), 42129869
create table gcrm.all_three3 as select * from gcrm.all_three2 as a where a.contact_id not in (select b.contact_id from gcrm.g3_ocmv_exclutionlist as b);
--Q43a
create table gcrm.all_three3_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from gcrm.all_three2 as a group by 1, 2;

--Q44. Bringing in RO details like total RO amount, RO work type, number and respective dealer
--42319551
create table gcrm.all_three_fact1 as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	up1.repm_ro_dtime,
	(up1.repm_bill_total_labr_amt + up1.repm_bill_total_othr_amt + up1.repm_bill_total_part_amt) as total_sales_amount,
	up1.repm_work_type,
	up1.repm_ro_no,
	up1.repm_dlr_no,
	(case 
		when up1.repm_work_type ='RR' then 1
		else 0
	end ) as ind_rr,
	(case 
		when up1.repm_work_type ='FS' then 1
		else 0
	end ) as ind_fs,
	(case 
		when up1.repm_work_type ='PS' then 1
		else 0
	end ) as ind_ps
from
	gcrm.all_three3 as mi
left outer join gcrm.ser_rcrepm_tb_4yr as up1 on
	up1.repm_vin = mi.vin
	and date(up1.repm_ro_dtime) between mi.prog_start_dt_new and mi.prog_end_dt_new
	and up1.repm_work_type in ('RR','FS','PS');

--Q45. Creating indicators for those who had placed at least an RO, type of work and numer of ROs placed in each type
--42129869
create table gcrm.all_three_fact2 as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	sum(mi.total_sales_amount) as total_ro_amount,
	count(repm_ro_no) as ro_count,
	(case
		when count(mi.repm_ro_no) > 0 then 1
		else 0
	end ) as bin_ro,
	max(ind_rr) as ind_rr,
	max(ind_ps) as ind_ps,
	max(ind_fs) as ind_fs,
	sum(ind_rr) as rr_count,
	sum(ind_ps) as ps_count,
	sum(ind_fs) as fs_count
from
	gcrm.all_three_fact1_deepa as mi
group by
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new;

--QC Check
select count(a.*) from gcrm.all_three_fact2 a where contact_id not in (select distinct contact_id from gcrm.contact_analysis_master_2);

--Q46a. Creating a contact table with only contact id, contact code, per title. per addr id and sex
create table gcrm.contact_analysis_master as 
select distinct a.row_id as contact_id , CON_CD, PER_TITLE , PR_PER_ADDR_ID, SEX_MF
from gcrm.s_contact as a;

--Q46b. Joining with s_addr_per using row_id to get city
-- 27,274,227 
create table gcrm.contact_analysis_master_1 as
select A.*, B.CITY
from gcrm.contact_analysis_master A 
left outer join gcrm.s_addr_per B on A.PR_PER_ADDR_ID = b.row_id;

--Q46c. Creating mapping table for city, state, region and zone using mapping given by business
create table city_mapping_final
(City_Code	varchar(20),City varchar(20),State varchar(20),Region varchar(20),zone varchar(20)
);	
copy gcrm.city_mapping_final from 'D:/CITY_MAPPING_FINAL_CSV.csv' delimiter ',' quote '"' csv header;

--Q46d. Now getting city, state, region and zone uing city code
create table gcrm.contact_analysis_master_2 as
select a.*, b.city as con_city_name, b.state as con_state, b.region as con_region , b.zone as con_zone
from gcrm.contact_analysis_master_1 as a 
left outer join  gcrm.city_mapping_final b on a.city = b.city_code;

--Q47a. Fact with contact details
--42129869
create table gcrm.fact_contact as
select fact.*, con.con_cd, con.sex_mf, con.city as city_code from gcrm.all_three_fact2 fact
left outer join gcrm.contact_analysis_master_2 con
on fact.contact_id = con.contact_id;

--Q47b. Fact_contact with campaign type
create table gcrm.fact_contact_camptype as
select fact.*, camp.campaign_type from gcrm.fact_contact fact
left outer join gcrm.our_s_src camp
on fact.new_camp_id = camp.new_camp_id;

--Q48. Fact for only Camps & Events
--32569421
create table gcrm.fact_camp_events as
select * from fact_contact_camptype
where campaign_type = 'Camps & Events';

--Excluding extreme RO values based on the car model and RO value
--Q50. Creating fact_camp_events2 with model column, 32569425
create table gcrm.fact_camp_events2 as select a.*, b.model_cd from gcrm.fact_camp_events as a left outer join gcrm.s_asset as b on a.vin = b.asset_num;
--149
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 200000;
--141
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 150000 AND a.total_ro_amount < 200000 AND a.model_cd IN ('New Verna','i20','Grand i10','Verna','Xcent','Santro','i10','New i20','Creta','Accent','Sonata','Getz','New Sonata','i20 Active','Eon');
--214
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 100000 AND a.total_ro_amount < 150000 AND a.model_cd IN ('Grand i10','Xcent','Santro','i10','Accent','Getz','Eon');
--(32569425-149-141-214) = 32568921

--Q51. Creating a table to store campaign-wise counts and distinct counts of contact_ids, asset_ids, vins, ROs and sum of ROs for all 49 campaigns (32 SMS only + 9 Both + 8 Email only)
create table gcrm.fact_camp_events2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist, count(a.total_ro_amount) as totamt_cnt, count(nullif(a.total_ro_amount,0)) as ro_non0_cnt, sum(a.total_ro_amount) as total_ro_val  from gcrm.fact_camp_events2 as a group by 1, 2;

--Q52a
create table gcrm.max_rodtime_details as
select
	camp_id,
	contact_id,
	vin,
	max (repm_ro_dtime) as max_rodt
from
	gcrm.all_three_fact1
where
	vin is not null
	and repm_ro_dtime is not null
	and repm_ro_no is not null
group by camp_id, contact_id, vin;

--Q52b
create table gcrm.ro_dimension as
select
	distinct mi.camp_id,
	mi.camp_name,
	mi.contact_id,
	mi.vin,
	mi.channel_name,
	mi.repm_dlr_no as Ro_dealer,
	up1.max_rodt as max_ro_dtime,
	mi.repm_ro_no,
	mi.repm_milg,
	mi.repm_work_type
from
	gcrm.camp_details_17 as mi
inner join gcrm.max_rodtime_details as up1 on
	up1.camp_id = mi.camp_id
	and up1.contact_id = mi.contact_id
	and up1.vin = mi.vin
	and up1.max_rodt = mi.repm_ro_dtime;

--Q52c. Bringing in all features under one table - RO, contact, vehicle and campaign
create table gcrm.fact_all as
select
	fact.*,
	ro.ro_dealer,
	ro.repm_ro_no,
	ro.repm_milg,
	ro.max_ro_dtime,
	ro.ro_state,
	ro.ro_region,
	ro.ro_zone,
	ro.active_from,
	ro.alias_name,
	asset.model_yr,
	asset.fuel_cd,
	asset.ext_color_cd,
	asset.warranty_start_dt,
	asset.warranty_end_dt,
	asset.dlr_id,
	asset.registered_dt,
	camp.ageofvehicle_targeted,
	camp.models_targeted ,
	camp.camp_sub_type,
	camp.frequency,
	camp.region,
	camp.SMS_sent,
	camp.Budget,
	city.city,
	city.statecode,
	city.state,
	city.region_new,
	city.zone
from
	gcrm.fact_camp_events2 fact
left join gcrm.ro_dimension ro on
	fact.new_camp_id = ro.new_camp_id
	and fact.contact_id = ro.contact_id
	and fact.vin = ro.vin
left join gcrm.s_asset asset on
	fact.asset_id = asset.row_id
left join test.camp_master1 camp on
	fact.new_camp_id = camp.new_camp_id
left join test.city_master city on
	fact.city_code = city.city_code;


--Part E - Effectiveness of EW Promotional Campaigns

-- Step 1  - SRC file get EW promotion ids
-- Step 2 - get relevant data from Email camps data
-- Step3 - get relevant data from SMS camps data
-- Step 4 - append above 2 tables 
-- remove contacts with no VIN
-- apply exclusion list on contact id
-- Exclusion list on VINs
-- prepare the Warranty table REg date -JAn2017 - Jun2019 and amount > 500
-- Dealer wise if repetition -  then perform same step by taking by contaid, campid, VIN, max reg date 
-- join the 2 tables 

-- count 86577
create table extended_warnty_1 as
select * from a_camp_con_14_prsp_con_contact_end as a
left outer join our_src as b on b.camp_id = a.src_id where  b.campaign_type='EW Promotion';

--count 73227
create table extended_warnty_2 as
select
	distinct camp.camp_id,
	camp.row_id as contact_id,
	veh.asset_num as vin,
	camp.asset_id,
	date(camp.prog_start_dt) as prog_start_dt,
	date(camp.prog_end_dt) as prog_end_dt,
	camp.campaign_name as camp_name,
	camp.channel as channel_name
from
	gcrm.extended_warnty_1 as camp
left outer join s_asset as veh on
	veh.row_id = camp.asset_id;

--count 69819
create table gcrm.extended_warnty_3  as
select * from gcrm.extended_warnty_2
where contact_id not in ( select * from ndms.g3_ocmv_exclutionlist);

--1,923,916
create table extended_warnty_4 as
select	*
from
	sms_contacts_4 as a
left outer join our_src as b on
	b.campaign_name = a.sms_campaign_name
where
	b.campaign_type = 'EW Promotion' ;

--1,501,616
create table gcrm.extended_warnty_5 as
select
	distinct sc.camp_id,
	sc.per_id as contact_id,
	veh.asset_num as vin,
	sc.asset_id,
	date (sc.prog_start_dt) as prog_start_dt,
	date(sc.prog_end_dt) as prog_end_dt,
	sc.campaign_name as camp_name,
	sc.channel as channel_name
from
	extended_warnty_4 as sc
left outer join s_asset as veh on
	veh.row_id = sc.asset_id;

--1,290,612
create table gcrm.extended_warnty_6  as
select * from gcrm.extended_warnty_5
where contact_id not in ( select * from ndms.g3_ocmv_exclutionlist);

--removing vin nulls
--sms campaign count 9,78,669
create table extended_warnty_7 as 
select * from extended_warnty_6 where vin is not null;

--email campaign 50447
create table extended_warnty_8 as 
select * from extended_warnty_3 where vin is not null;

--appending data from both email and sms campaigns
--count 9,78,669
create table extended_warnty_9 as 
select * from extended_warnty_7;

--50447
insert into extended_warnty_9
select * from extended_warnty_8;

--Extended warranty table  with 2017 to 2019 june and >500 warranty amount
create table extended_warranty_threeyears_data as
select * from ndms.ser_rgextb_tb
where extract( year from date(extb_reg_date))>=2017 and extract ( year from date(extb_reg_date))<=2019;

--1,034,373
create table gcrm.extended_warnty_10 as
select
	distinct sc.camp_id,
	sc.contact_id,
	sc.vin,
	sc.asset_id,
	sc.prog_start_dt,
	sc.prog_end_dt,
	sc.camp_name,
	sc.channel_name,
	sum (am.extb_wrnty_amt) as Total_extb_wrnty_amnt,
	am.extb_dlr_no,
	am.extb_wrnty_no,
	date(am.extb_reg_date) as extb_reg_date
from
	extended_warnty_9 as sc
left outer join extended_warranty_threeyears_data as am on
	am.extb_vin = sc.vin
group by
	sc.camp_id,
	sc.contact_id,
	sc.vin,
	sc.asset_id,
	sc.prog_start_dt,
	sc.prog_end_dt,
	sc.camp_name,
	sc.channel_name,
	am.extb_reg_date,
	am.extb_dlr_no,
	am.extb_wrnty_no;

--Bringing in all features under one table - RO, contact, vehicle and campaign
create table gcrm.ew_all as
select
	fact.*,
	asset.model_cd,
	asset.model_yr,
	asset.fuel_cd,
	asset.ext_color_cd,
	asset.warranty_start_dt,
	asset.warranty_end_dt,
	asset.dlr_id,
	asset.registered_dt,
	camp.ageofvehicle_targeted,
	camp.models_targeted ,
	camp.camp_sub_type,
	camp.frequency,
	camp.region,
	camp.SMS_sent,
	camp.Budget,
	contact.con_cd,
	contact.sex_mf,
	contact.city,
	contact.con_city_name,
	contact.con_state,
	contact.con_region,
	contact.con_zone
from
	gcrm.extended_warnty_10 fact
left join gcrm.s_asset asset on
	fact.asset_id = asset.row_id
left join test.camp_master1 camp on
	fact.new_camp_id = camp.new_camp_id
left join test.contact_master contact on
	fact.contact_id = contact.contact_id;
----------------------------------------------------------------------------------------------------------------------------------
--Initially there were 66 email campaigns (52 + 14)

--Five email campaigns with con_per_ids from s_camp_con
--6383270
create table camp_con_5_1 as
select
	distinct a.src_id as camp_id,
	a.con_per_id,
	a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-17OVJ5H','1-1EDYJB6','1-1F2I7QH','1-1FGSQR5','1-1FZ04OB');
	
--Asset ids from s_asset_con for con_per_ids of those five email campaigns
--7132506
create table gcrm.camp_con_5_2 as
select
	a.camp_id,
	a.con_per_id,
	b.contact_id,
	b.asset_id
from
	gcrm.camp_con_5_1 as a
left outer join gcrm.s_asset_con as b on
	a.con_per_id = b.contact_id;

--Analysis of prospects
--Creating a table with list of distinct prsp_con_per_ids for the 27 campaigns with only prospects
--7447268
create table gcrm.dist_prosp_27 as
select
	distinct a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-ANFRFX','1-AXH9AX','1-CQV09V','1-GDE874','1-HH7IWN','1-BR7XJ4','1-FPG6T5','1-FCGO5Q','1-G5QMCP','1-I7S8MD','1-KGWAX9','1-KGWBGZ','1-HLQOFL','1-P3CLGG','1-BR7XQF','1-J39WPC','1-EIEJ79','1-F29BMX','1-JEQ4XN','1-BR7Y3X','1-GDE84T','1-ED6724','1-P3CLPH','1-QAA78U','1-U7XQH9','1-DG2D0E','1-D8FDZP');

--Creating a table for contact details of the above list of prsp_con_per_ids by merging it with s_prsp_contact
--7447268
create table gcrm.prosp_cont_27 as
select
	a.prsp_con_per_id,
	b.last_name,
	b.email_addr,
	b.full_name,
	b.fst_name,
	b.city
from
	dist_prosp_27 as a
left outer join s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--43
select count(*) from gcrm.prosp_cont_27 as a where a.last_name is null or a.email_addr is null;

--Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using email_addr and last_name
--7513570
create table gcrm.prosp_s_cont_27 as
select
	a.prsp_con_per_id,
	b.row_id,
	a.email_addr as prosp_email,
	b.email_addr as email,
	a.last_name as prosp_last_name,
	b.last_name
from
	prosp_cont_27 as a
left outer join s_contact as b on
	(a.email_addr = b.email_addr and a.last_name = b.last_name);

--some checks
--236800
select count(*) from gcrm.prosp_s_cont_27 as a where a.email = a.prosp_email and a.last_name = a.prosp_last_name;
--236800
select count(*) from gcrm.prosp_s_cont_27 as a where a.email = a.prosp_email;

--To identify if the above list of prospects with entries in s_contact also have asset_nums(VIN) in s_asset
--7514224
create table gcrm.prosp_asset_27 as
select
	a.row_id,
	b.pr_con_id,
	b.asset_num,
	b.pr_asset_id
from
	prosp_s_cont_27 as a
left outer join s_asset as b on
	a.row_id = b.pr_con_id;

--some checks
--45540
select count(*) from gcrm.prosp_asset_27 as a where a.asset_num is not null;
--36826
select count(distinct a.asset_num) from gcrm.prosp_asset_27 as a;
--36280
select count(distinct a.pr_con_id) from gcrm.prosp_asset_27 as a;
--211778
select count(distinct a.row_id) from gcrm.prosp_asset_27 as a;
--45540
select count(*) from gcrm.prosp_asset_27 as a where a.row_id = a.pr_con_id;

--Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using only email_addr, not last_name
--Below query takes more than 6500 secs(doesn't end)
create table prosp_s_cont_27_email as
select
	a.prsp_con_per_id,
	b.row_id,
	a.email_addr as prosp_email,
	b.email_addr as email,
	a.last_name as prosp_last_name,
	b.last_name
from
	prosp_cont_27 as a
left outer join s_contact as b on
	(a.email_addr = b.email_addr);

--prsp_con_per_ids for 27 email campaigns with only prospects
--7522599
create table prosp_asset_con_27 as
select
	a.row_id,
	b.contact_id,
	b.asset_id
from
	prosp_s_cont_27 as a
left outer join s_asset_con as b on
	a.row_id = b.contact_id;

--Asset ids from s_asset_con for con_per_ids of those five email campaigns
--7522599
create table prosp_ast_con_ast_27 as
select
	a.row_id,
	a.contact_id,
	a.asset_id,
	b.row_id as ast_row_id,
	b.pr_con_id,
	b.asset_num,
	b.pr_asset_id
from
	prosp_asset_con_27 as a
left outer join s_asset as b on
	a.asset_id = b.row_id;

--Creating a table for camp_id and prsp_con_per_ids for the 27 campaigns with only prospects
--9853942
create table gcrm.camp_con_27_1 as
select distinct
	a.src_id as camp_id,
	a.con_per_id,
	a.prsp_con_per_id
from
	s_camp_con as a
where
	a.src_id in ('1-154L44P','1-ANFRFX','1-AXH9AX','1-BR7XJ4','1-BR7XQF','1-BR7Y3X','1-CQV09V','1-D8FDZP','1-DG2D0E','1-ED6724','1-EIEJ79','1-F29BMX','1-FCGO5Q','1-FPG6T5','1-GDE84T','1-GDE874','1-HH7IWN','1-HLQOFL','1-I7S8MD','1-J39WPC','1-JEQ4XN','1-KGWAX9','1-KGWBGZ','1-P3CLGG','1-P3CLPH','1-QAA78U','1-T1YOOF');

--Joining those 27 campaigns and its prospects with s_prsp_contact for prospects' row_id, email, last name and phone
--9853942
create table gcrm.camp_con_27_2 as
select
	a.*,
	b.row_id as prsp_row_id,
	b.email_addr as prsp_email,
	b.last_name as prsp_l_name,
	b.cell_ph_num as prsp_phone
from
	gcrm.camp_con_27_1 as a
left outer join s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--Creating a table to store counts of records, prospects and distinct prospects for each camp_id
create table gcrm.camp_con_27_2_count as
select
	a.camp_id,
	count(*),
	count(a.prsp_row_id),
	count(distinct a.prsp_row_id)
from
	gcrm.camp_con_27_2 as a
group by 1;

--Check
select
	camp_id,
	prsp_email,
	prsp_l_name,
	count(*)
from
	camp_con_27_2
group by 1, 2, 3
having count(*) > 500;

--Creating a table for those prospects with entries in s_contact(to identify if they are also owners of hyundai cars) using both email_addr and last_name
--10524063
create table camp_con_27_3 as
select
	a.*,
	b.row_id as cont_row_id,
	b.cell_ph_num
from
	camp_con_27_2 as a
left outer join s_contact as b on
	lower(trim(a.prsp_email)) = lower(trim(b.email_addr))
	and lower(trim(a.prsp_l_name)) = lower(trim(b.last_name));

--Grabbing the asset_ids of those prospects who had entries in s_contact
--10678148
create table gcrm.camp_con_27_4 as
select
	a.*,
	b.asset_id,
	b.row_id as asset_con_row_id
from
	gcrm.camp_con_27_3 as a
left outer join gcrm.s_asset_con b on
a.cont_row_id = b.contact_id;

--Creating a table to store counts of records, asset_ids and distinct asset_ids for each of those 27 campaigns
create table gcrm.camp_con_27_4_count as
select
	a.camp_id,
	count(*),
	count(a.asset_id),
	count(distinct a.asset_id)
from
	gcrm.camp_con_27_4 as a
group by 1;

--Pulling out src, con_per & prsp_con_per from camp_con for 14 more campaigns (small camp_con for only 14 campaigns)
--37,34,134
create table gcrm.a_camp_con_14 as
select distinct
	src_id,
	con_per_id,
	prsp_con_per_id
from
	gcrm.s_camp_con
where
	src_id in ('1-CQV092','1-G5QMCP','1-P3CLFK','1-P3CLFN','1-BR7XPG','1-BR7XQ9','1-ED671B','1-19W84A2','1-ZPNIVN','1-U7XQH9','1-VYE9WV','1-RUISW7','1-1163Q16','1-GMAW9H');

--Out of those 14 campaigns, three only have contacts
--41,41,176
create table gcrm.a_camp_con_14_contact as
select
	a.src_id,
	a.con_per_id,
	b.asset_id
from
	gcrm.a_camp_con_14 as a
left outer join gcrm.s_asset_con as b on
	b.contact_id = a.con_per_id
where
	a.src_id in ('1-1163Q16','1-RUISW7','1-VYE9WV');

--Combining 5 and 3 email campaigns with contacts
--1-17OVJ5H,1-1EDYJB6,1-1F2I7QH,1-1FGSQR5,1-1FZ04OB,1-1163Q16,1-RUISW7 and 1-VYE9WV
create table gcrm.camp_con_8 as
select * from gcrm.camp_con_5_2;	

--1,10,05,402
insert into	gcrm.camp_con_8(camp_id, con_per_id, asset_id)
select a.src_id, a.con_per_id, a.asset_id
from gcrm.a_camp_con_14_contact as a
where a.asset_id is not null or a.con_per_id is not null;

--Out of eight email campaigns with contacts, 1-1163Q16 has very less number of VINs, hence ignoring 1-1163Q16
--1,09,94,265
create table gcrm.camp_con_8_2 as
select	*
from
	gcrm.camp_con_8
where
	camp_id in ('1-1FGSQR5','1-1FZ04OB','1-AXH9AX','1-HLQOFL','1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-G5QMCP','1-T1YOOF','1-VYE9WV','1-HH7IWN','1-ANFRFX','1-RUISW7','1-U7XQH9','1-P3CLPH','1-154L44P','1-1EDYJB6');

--Grabbing row_id from s_camp_con
--1,11,24,777
create table gcrm.camp_con_8_3 as 
select
	a.camp_id,
	a.con_per_id,
	b.row_id as camp_con_row_id
from
	gcrm.camp_con_8_2 as a,
	gcrm.s_camp_con as b
where
	a.camp_id = b.src_id
	and a.con_per_id = b.con_per_id;

--Obtaining last name, email address and row id of all prospects of those 14 campaigns
--1,25,368
create table gcrm.a_camp_con_14_prsp_con as
select
	distinct a.src_id,
	a.prsp_con_per_id,
	b.last_name,
	b.email_addr,
	b.row_id
from
	gcrm.a_camp_con_14 as a
left outer join gcrm.s_prsp_contact as b on
	a.prsp_con_per_id = b.row_id;

--Only two email campaigns had considerable number of VINs, obtaining row_ids from s_contact for those two using last name and email address
--1,30,578
create table gcrm.a_CAMP_con_14_prsp_con_contact as
select distinct
	a.src_id,
	a.prsp_con_per_id,
	a.last_name,
	a.email_addr,
	b.row_id
from
	gcrm.a_camp_con_14_prsp_con as a
left outer join gcrm.s_contact as b on
	b.email_addr = a.email_addr
	and b.last_name = a.last_name
	where a.src_id in ('1-G5QMCP', '1-U7XQH9');

--Getting the asset ids for those prospects
--1,31,376
create table gcrm.a_CAMP_con_14_prsp_con_contact_end as
select
	distinct a.src_id,
	a.prsp_con_per_id,
	a.row_id,
	b.asset_id
from
	gcrm.a_CAMP_con_14_prsp_con_contact as a
left outer join gcrm.s_asset_con as b on
	a.row_id = b.contact_id;

--Keeping only the valid 17 email and both campaigns
create table gcrm.fact_table_RO as 
select distinct a.row_id , a.src_id , a.asset_id 
from  a_camp_con_14_prsp_con_contact_end a
where src_id in ('1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-1EDYJB6','1-1FGSQR5','1-1FZ04OB','1-VYE9WV','1-RUISW7','1-ANFRFX','1-P3CLPH','1-G5QMCP','1-U7XQH9','1-154L44P','1-HLQOFL','1-AXH9AX','1-T1YOOF','1-HH7IWN');

--Removing those contacts in ocmv_exclutionlist
--12266232
create table gcrm.fact_table_RO_1  as
select * from gcrm.fact_table_RO
where row_id not in ( select * from ndms.g3_ocmv_exclutionlist);

--Getting camp names, channel name, prog start and end dates for 17 campaigns
--1,22,66,232
create table gcrm.fact_table_RO_2 as
select
	distinct src.row_id as camp_id,
	camp.row_id as contact_id,
	veh.asset_num as vin,
	camp.asset_id,
	date(src.prog_start_dt) as prog_start_dt,
	date(src.prog_end_dt) as prog_end_dt,
	src."name" as camp_name,
	(case
		when src.prog_start_dt is not null then 'EMAIL'
	end )as channel_name
from
	gcrm.fact_table_RO_1 as camp
left outer join s_src as src on
	src.row_id = camp.src_id
left outer join s_asset as veh on
	veh.row_id = camp.asset_id;

--Removing contacts in g3_ocmv_exclutionlist
--1,21,40,803
create table gcrm.final_fact_email as
select
	*
from
	gcrm.fact_table_ro_2 as a
where
	a.contact_id not in (
	select
		*
	from
		gcrm.g3_ocmv_exclutionlist);

--Getting new campaign display names, channel clubbed, new prog start and end dates for 17 campaigns from source table
--1,17,28,921
create table most_final_fact_email as
select 
	a.*,
	b.old_camp_id ,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed
from
	gcrm.final_fact_email as a
left outer join gcrm.our_s_src as b on
	a.camp_id = b.old_camp_id;
	
----------------------------------------------------------------------------------------------------------------------------------


--Q1
create table again_most_final_fact_email as
select 
	a.*,
	b.old_camp_id ,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed
from
	gcrm.final_fact_email as a
left outer join gcrm.our_s_src as b on
	a.camp_id = b.old_camp_id;

--Q2
create table again_most_final_fact_sms as
select 
	a.*,
	b.old_camp_id ,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed
from
	gcrm.sms_cont_vin_7 as a
left outer join gcrm.our_s_src as b on
	a.camp_name = b.old_campaign_name;

--Q3. creating table for contacts who have been contacted via BOTH by INTERSECTION
create table gcrm.again_most_final_fact_both_2 as
	select
		distinct a.new_camp_id,
		a.new_campaign_disp_name,
		a.contact_id,
		a.asset_id,
		a.vin,
		a.prog_start_dt_new,
		a.prog_end_dt_new,
		a.channel_clubbed
	from
		gcrm.again_most_final_fact_email a
	inner join gcrm.again_most_final_fact_sms b on
		a.new_camp_id = b.new_camp_id
		and a.contact_id = b.contact_id
		and a.channel_clubbed = 'Both'
		and b.channel_clubbed = 'Both'
		and a.asset_id is not null 
		and length(a.asset_id)>2;

--Q4
insert
	into
	gcrm.again_most_final_fact_both_2 (new_camp_id,
	new_campaign_disp_name,
	contact_id,
	asset_id,
	vin,
	prog_start_dt_new,
	prog_end_dt_new,
	channel_clubbed)
select
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.contact_id,
	b.asset_id,
	b.vin,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed from gcrm.again_most_final_fact_sms as b where b.channel_clubbed = 'SMS only' and b.asset_id is not null and length(b.asset_id)>2;
	
--Q5
insert
	into
	gcrm.again_most_final_fact_both_2 (new_camp_id,
	new_campaign_disp_name,
	contact_id,
	asset_id,
	vin,
	prog_start_dt_new,
	prog_end_dt_new,
	channel_clubbed)
select
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.contact_id,
	b.asset_id,
	b.vin,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed from gcrm.again_most_final_fact_email as b where b.channel_clubbed = 'Email only' and b.asset_id is not null and length(b.asset_id)>2;

--Q6
create table gcrm.both_email_sms_model as 
select a.*, c.campaign_type
from gcrm.again_most_final_fact_both_2  a
left outer join gcrm.our_s_src c on a.new_camp_id =c.new_camp_id; 

--Q7a. 2nd level INTERSECTION for finding contacts with who overlap in all 2 channels
create table gcrm.inter_all as
select distinct a.vin,a.contact_id from gcrm.both_email_sms_model a where a.channel_clubbed = 'Both' and a.campaign_type = 'Camps & Events';
vacuum gcrm.inter_all;

--Q7b
create table gcrm.inter_all_2 as
select distinct a.vin,a.contact_id from gcrm.both_email_sms_model a inner join gcrm.inter_all b on a.vin=b.vin and a.contact_id=b.contact_id where a.channel_clubbed = 'Email only' and a.campaign_type = 'Camps & Events';
vacuum gcrm.inter_all_2;

--Q7c
create table gcrm.inter_all_3 as
select distinct a.vin,a.contact_id from gcrm.both_email_sms_model a inner join gcrm.inter_all_2 b on a.vin=b.vin and a.contact_id=b.contact_id where a.channel_clubbed = 'SMS only' and a.campaign_type = 'Camps & Events';

--Q8a. Figuring out valid phone & email
create table gcrm.s_per_comm_addr_ph1 as select distinct a.per_id, a.addr as phone from gcrm.s_per_comm_addr as a where a.comm_medium_cd='Phone';

--Q8b
create table gcrm.s_per_comm_addr_em1 as select distinct a.per_id, a.addr as email from gcrm.s_per_comm_addr as a where a.comm_medium_cd='Email';

--Q8c
create table gcrm.ph_cnt as select phone, count(*), count(distinct per_id) as d_per from gcrm.s_per_comm_addr_ph1 group by 1;

--Q8d
create table gcrm.em_cnt as select email, count(*), count(distinct per_id) as dist_per from gcrm.s_per_comm_addr_em1 group by 1;

--Q9a. Removing phone number where a phone number is mapped to more than 5 contacts
create table gcrm.ph_excl as 
select * from gcrm.s_per_comm_addr_ph1 a where a.phone not in (select distinct phone from gcrm.ph_cnt b where b.d_per>5) ;

--Q9b.
create table gcrm.em_excl as 
select * from gcrm.s_per_comm_addr_em1 a where a.email not in (select distinct email from gcrm.em_cnt b where b.dist_per>5) ;

--Q10. Invalid phone & email list
create table gcrm.inv_ph as
select
	phone
from
	gcrm.s_per_comm_addr_ph1
where 
	phone like '+%'
	or phone like '0%'
	or phone like '1%'
	or phone like '2%'
	or phone like '3%'
	or phone like '4%'
	or phone like '5%'
	or length(phone)<10;

--Q11
create table gcrm.inv_em as
select email from gcrm.s_per_comm_addr_em1 where email like '%@gmial.com' or email like '%@na.com' or email like '%nil.com' or email like '%gmil.com' or email like '%gail.com';

--Creating table for applying grouping logic
--Q12a
create table gcrm.modelling_v4_6 as 
select a.vin, a.contact_id, b.phone from gcrm.inter_all_3 a left outer join gcrm.ph_excl b on a.contact_id = b.per_id;
--Q12b
create table gcrm.modelling_v4_7 as 
select a.vin, a.contact_id, a.phone, b.email from gcrm.modelling_v4_6 a left outer join gcrm.em_excl b on a.contact_id = b.per_id;
--Q12c
create table gcrm.modelling_v4_8 as 
select * from gcrm.modelling_v4_7 a where a.contact_id not in (select * from gcrm.g3_ocmv_exclutionlist);
--Q12d
create table gcrm.modelling_v4_9 as
select * from gcrm.modelling_v4_8 a where phone is not null or email is not null;
--Q12e
create table gcrm.modelling_v4_10 as
select * from gcrm.modelling_v4_9 where phone not in (select phone from gcrm.inv_ph) or phone is null;
--Q12f
create table gcrm.modelling_v4_11 as
select * from gcrm.modelling_v4_10 where email not in (select email from gcrm.inv_em) or email is null;

---------------------------------------------------------------------------------------------------------------
--prepping s_per_comm_addr with two seperate columns for phone and email
--creating per_comm_addr for email
create table gcrm.s_per_comm_addr_em1 as select distinct a.per_id, a.addr as email from gcrm.s_per_comm_addr as a where a.comm_medium_cd='Email';

alter table gcrm.s_per_comm_addr_ph1 rename column addr to phone;

--creating per_comm_addr for both phone and email, 27079343
--22449017
select count(*) from gcrm.s_per_comm_addr_ph1 as a;
--20075685
select count(distinct a.per_id) from gcrm.s_per_comm_addr_ph1 as a;
--15830002
select count(*) from gcrm.s_per_comm_addr_em1 as a;
--14380677
select count(distinct a.per_id) from gcrm.s_per_comm_addr_em1 as a;


--22957844
create table gcrm.s_per_comm_ph_email1 as select distinct a.per_id from gcrm.s_per_comm_addr as a;
--25331176
create table gcrm.s_per_comm_ph_email2 as select distinct a.per_id, b.phone from gcrm.s_per_comm_ph_email1 as a left outer join gcrm.s_per_comm_addr_ph1 as b on a.per_id = b.per_id;
--28352579
create table gcrm.s_per_comm_ph_email3 as select distinct a.per_id, a.phone, b.email from gcrm.s_per_comm_ph_email2 as a left outer join gcrm.s_per_comm_addr_em1 as b on a.per_id = b.per_id;

--28352579, 25299333, 19294526
select count(*), count(a.phone), count(a.email) from gcrm.s_per_comm_ph_email3 as a;
--0
select count(*) from gcrm.s_per_comm_ph_email3 as a where a.email is null and a.phone is null;
--16241280
select count(*) from gcrm.s_per_comm_ph_email3 as a where a.phone is not null and a.email is not null;


create table gcrm.cust_seg_temp1 as
select
	distinct
	a.asset_num,
	b.asset_id,
	b.contact_id,
	c.phone,
	c.email
from
	gcrm.s_asset as a
left outer join gcrm.s_asset_con as b on
	a.row_id = b.asset_id
left outer join gcrm.s_per_comm_ph_email3 as c on
	b.contact_id = c.per_id
where
	a.asset_num in ('MALAN51CLDM458039','MALAA51HLAM548631','MALBB51BLAM179175','MALA151ALBM028281','MALAA51HLAM590084','MALBM51BLKM677437','MALAB51HR7M169222','MALAA51HR5M665626','MALAA51HR8M258506','MALAA51HLBM667735','MALAA51HLBM663911','MALA841DLEM027680','MALAB51GRYM110588','MALAA51HR8M349837','MALAA51HR4M434869','MALA851CLJM781713','MALBM51RLHM478415','MALBM51BLKM682171','MALAA51GR1M184902','MALAA51HLDM800596','MALBU51HR5M008630','MALAA51HR5M650024','MALBM51BLFM089418','MALA151ALCM064792','MALAA51HR7M234059','MALCG41GR5M138828','MALBM51BLKM687157','MALCU41RLDM136760','MALCH41GR2M048924','MALBM51BLKM678262','MALC181RLKM555536','MALBM51BLKM670707','MALBM51RLKM683673','MALC841DMKM133690','MALBB51RLDM609343','MALA251ALHM586138','MALA851CMHM755921','MALC181RLKM552289','MALC841CLKM131987','MALBM51BLKM688290','MALAA51HLBM679394','MALBB51SLBM381106','MALC181RLKM553279','MALBM51RLHM468681','MALA851CLFM243133','MALA251ALCM044792','MALA851CLKM982226','MALBU51HR5M008638','MALBB51RLAM256966','MALC841DLJM109421','MALAA51HLAM571425','MALBT51HR5M011541','MALA251ALHM587570','MALA351ALHM582519','MALC841DLHM017385','MALC381CLKM533676','MALA741CLKM365755','MALC281RLKM557467','MALEN41BR1M000712','MALCU41ULBM028805','MALA351ALDM167311','MALAB51HR7M187652','MALBL51RLGM310061','MALBL51RLGM310070','MALBB51RLCM458131','MALCU41ULDM104759','MALBL51RLGM341551','MALBB51SLBM379479','MALAN51CR8M135944','MALC381ULHM319643','MALCU41ULFM193139','MALCU41ULCM094326','MALA751ELHM609324','MALBB51RLBM289170','MALBM51RLKM697703','MALDN41VR4M000306','MALA151ALGM476057','MALAC51GR1M138855','MALAN51CLBM894517','MALAA51HLAM582485','MALAM51BR8M007699','MALAA51HR9M428664','MALCM41VR6M003945','MALA251ALEM361422','MALCH41GR1M025516','MALCN41CR7M020746','MALET41VR7M001044','MAHAA51GRXM032800','MALCU41ULEM153011','KMHJM81VR5U228211','MALBB51BLCM504318','MALAA51HR8M311458','MALCN41VR9M063455','MALC381ULFM025207','MALBM51RLFM168171','MALA851CLHM634505','MALC381ULHM218023','MALA351ALHM587484','MALC181RLHM237341','MALC281UMHM337188','MALCT41RLDM129318','MALAA51HLDM807092','MALCM41CR7M028116','MALBB51RLCM403263','MALBM51RLEM011336','MALCT41RLBM024137','MALBM51BLKM688500','MALCN41VR8M040305','MAHCH41GRXM000183','MALAN51BR8M024660','MALDN41VR5M005582','MALDN41VR5M006203','MALBU51HR5M008639','MALA851CLGM512727','MALBL51RLGM341548','MALA151ALGM477828','MALBL51RLGM310086','MALBM51BTHM463373','MALCM41VR8M052244','MALAB51HR5M749818','MALCH41GR3M058375','MALAA51HR6M835712','MALCM41VR7M021204','MALCH41CR6M150361','MALAA51HR6M790568','MALBB51BLCM501942','MALCH41GR1M022866','MALBM51BTJM553312','MALBL51RLGM310071','MALCU41ULCM084974','MALCN41VR8M055029','MALBB51BLCM401060','MALCN41VLAM083302','MALBB51SR9M104492','MALA741DLGM176115','MALCM41VR6M004814','MALDN41VR4M000308','MALCN41VLAM096553','MALBB51SR9M064621','KMHJM81VR5U236327','MAHAA51GRWM000437','MALA151ALDM167971','MALCT41CLDM134281','MALAA51HR8M379128','MALA851CLGM574213','MALA151ALGM477538','MALA151ALGM475982','MALA151ALGM478227','MALA151ALGM478204','MALA151ALGM480969','MALJ381AMGM010609','MALBL51RLGM341562','MALBL51RLGM341546','MALBL51RLGM341577','MALBL51RLGM341549','MALA151ALGM480974','MALA151ALGM505386','MALCU41UMCM063740','MALAC51HR3M391693','MALAM51BLCM147569','MALAB51HR7M124943','MALCH41WR6M164592','MALAB51HR6M920501','MALAM51CLAM725898','MALBB51RLCM403271','KMHSH81XNBU703346','MALCM41VR6M000420','MALAM51CLAM777847','MALCM41VR8M048849','MALAA51HR6M792259','MALAN51CLCM312785','MALBB51SLAM140401','MALAB51HR4M580339','KMHSH81XNAU701488','MALCG41GR6M165560','MALBB51BLDM523432','MALA251ALDM162038','MALBB51RLDM520364','MALBB51BLDM523997','MALAA51HR9M431457','MALA251ALDM163743','MALBB51RLDM520301','MALBB51BR9M114838','MALBB51RLDM520323','MALBB51BLDM522736','MAHAA51GRWM002402','MALCG41GR9M238380','MALBB51BR9M055549','MALDH41ULDM013164','MALCN41VR9M078075','MALDH41ULDM013218','MALAN51CR9M328026','MALA251ALDM160662','MALAA51HR9M482858','MALBB51RLDM515025','MALAA51HR9M484058','MAHAA51GRXM062775','MALBB51BLDM520581','MALAN51CR9M330300','MALAN51CR9M330289','MALAA51GRYM104073','MALBB51BLDM521245','MALA251ALDM163209');



select
	a.asset_num,
	count(*) as row_cnt,
	count(a.contact_id) as cont_id,
	count(distinct a.contact_id) as dist_cont_id,
	count(a.phone) as phone,
	count(distinct a.phone) dist_phone,
	count(a.email) email,
	count(distinct a.email) as dist_email
from
	gcrm.cust_seg2 as a
group by
	1;

select a.addr, a.x_is_bounced, count(*) from gcrm.s_per_comm_addr as a where a.addr in ('na@gmail.com','nil.nil@gmail.com','nill@gmail.com','n@n.com','abc@gmail.com','no@gmail.com','nil@gmail.com','na@na.com','123@gmail.com','null@null.com','nil@nilgmail.com','n@gmail.com','sales@gmail.com','nomail@gmail.com','a@gmail.com','chandkhedabackoffice@gmail.com','.@gmail.com','republichyundai@rediffmail.com','nomailid@gmail.com','raja@gmail.com','rajesh@gmail.com','s@gmail.com','nil1@gmail.com','nil1@nil.com','n@ngmail.com','nil.@nil.com','noemail@gmail.com','suresh@gmail.com','ramesh@gmail.com','customercommon321@gmail.com','baggahyundaigm@gmail.com','noid@gmail.com','nill.nill@gmail.com','kumar@gmail.com','xyz@gmail.com','vijay@gmail.com','sanjay@gmail.com','amit@gmail.com','rahul@gmail.com','deepak@gmail.com','ravi@gmail.com','na@nil.com','ril@nil.com','ab@gmail.com','manoj@gmail.com','prestigevehicles@gmail.com','ashok@gmail.com','rakesh@gmail.com','sales@dreamhyundai.in','sandeep@gmail.com','nomail@nomail.com','..@gmail.com','aaa@gmail.com','arun@gmail.com','mohan@gmail.com','nill@nil.com','ajay@gmail.com','p.das@gmail.com','nill@nill.com','akashhyundai@yahoo.com','nil@nil.com','raj@gmail.com','singh@gmail.com','na.na@gmail.com','mahesh@gmail.com','dinesh@gmail.com','ram@gmail.com','manish@gmail.com','1@gmail.com','12@gmail.com','service@gmail.com','soni11453@gmail.com','null@gmail.com','vinod@gmail.com','sunil@gmail.com','mukesh@gmail.com','ola@gmail.com','anil@gmail.com','na@in.com','ss@gmail.com','r@gmail.com','k@gmail.com','prakash@gmail.com','p@gmail.com','crm@kamalhyundai.com','nil123@gmail.com','raju@gmail.com','akashhyundai@gmail.com','borahhyundaisales@hotmail.com','krishna@gmail.com','joshi@gmail.com','kun@gmail.com','srinivas@gmail.com','pradeep@gmail.com','ashish@gmail.com','a@a.com','pankaj@gmail.com','na@sify.com','praveen@gmail.com','naveen@gmail.com','hyundai@gmail.com','nail@nail.com','456@gmail.com','m@gmail.com','goyal@gmail.com','santosh@gmail.com','sas@gmail.com','g@gmail.com','sachin@gmail.com','abhishek@gmail.com','rohit@gmail.com','nilmail@nil.com','4567@gmail.com','jai@gmail.com','prathamhyundai@gmail.com','vishal@gmail.com','nil.nil@nil.com','asd@gmail.com','nila@gmail.com','nil12@gmail.com','vatsalhyundai@gmail.com','kiran@gmail.com','nilnil@gmail.com','naresh@gmail.com','satish@gmail.com','vikas@gmail.com','prasad@gmail.com','sansaihyundaisales@gmail.com','nitin@gmail.com','d@gmail.com','anand@gmail.com','notgiven@gmail.com','chandkheda@gmail.com','n@nil.com','aa@gmail.com','customer.patelhyundai@gmail.com','nil.@gmail.com','neel@neel.com','ganesh@gmail.com','abs@gmail.com','harish@gmail.com','prestigevehicle@gmail.com','jmu@gmail.com','rajendra@gmail.com','vivek@gmail.com','abcd@gmail.com','nil@mail.com','gaurav@gmail.com','mail@gmail.com','rajkumar@gmail.com','shakunhyundai@gmail.com','anilkumar@gmail.com','noemailid@gmail.com','nile@nile.com','vkautoudh@gmail.com','bharat@gmail.com','lakshmiservice_rjy@yahoo.co.in','babu@gmail.com','salesatktc@gmail.com','sanjeev@gmail.com','sanmati.hyundai@gmail.com','yogesh@gmail.com','nil12@nil.com','ankit@gmail.com','arvind@gmail.com','abdul@gmail.com','rr@gmail.com','republicservice@rediffmail.com','toconfrim@modihyundai.co.in','pawan@gmail.com','republic@gmail.com','sumit@gmail.com','hari@gmail.com','a@b.com','kunecilbodyshop@gmail.com','amravati@gmail.com','nil.ktym@gmail.com','rao@gmail.com','vinay@gmail.com','sharma@gmail.com','borah@gmail.com','nil@nil.net','rajeev@gmail.com','customer.hyundai@gmail.com','dilip@gmail.com','sales@surjeethyundai.com','gopal@gmail.com','v@gmail.com','n@a.com','kamal@gmail.com','planet.naranpura1@gmail.com','toconfirm@modihyundai.co.in','nillnill@gmail.com','jitendra@gmail.com','prashant@gmail.com','vishnu@gmail.com','sales@hotmail.com','ni@gmail.com','xx.@xxgmail.com','none@gmail.com') group by 1, 2;
select distinct a.x_is_bounced from gcrm.s_per_comm_addr as a where a.addr in ('raja@gmail.com');

CREATE TABLE gcrm.again_most_final_fact_both_2 (
              new_camp_id varchar(20) NULL,
              new_campaign_disp_name varchar(100) NULL,
              contact_id varchar(15) NULL,
              asset_id varchar(15) NULL,
              vin varchar(100) NULL,
              prog_start_dt_new timestamp NULL,
              prog_end_dt_new timestamp NULL,
              channel_clubbed varchar(20) NULL
);

copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_1.csv' delimiter ',' quote '"' csv header;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_2.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_3.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_4.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_5.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_6.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_7.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_8.csv' delimiter ',' quote '"' csv;
copy gcrm.again_most_final_fact_both_2 from 'D:/Aravindh/both_intersect/both_intersect_9.csv' delimiter ',' quote '"' csv;


copy (select * from gcrm.ser_rcrepm_tb_4yr as a where extract(year from a.repm_ro_dtime) = 2016) to 'D:/ro_2016.csv' with csv delimiter ',';


-----------------------------------------------------------------------------------------------------------------------------

select a.row_id, a."name", a.prog_start_dt, a.prog_end_dt, a.prog_start_dt + interval '44 day' from s_src as a where a.row_id in ('1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-1EDYJB6','1-1FGSQR5','1-1FZ04OB','1-VYE9WV','1-RUISW7','1-ANFRFX','1-P3CLPH','1-G5QMCP','1-U7XQH9','1-154L44P','1-HLQOFL','1-AXH9AX','1-T1YOOF','1-HH7IWN');


select * from sms_comb_file_names as a where a.sms_campaign_name = 'Women’sDaySMS_March18';

select count(*), count(distinct a.comm_medium_cd) from gcrm.s_per_comm_addr as a;
select a.comm_medium_cd, count(*), count(a.addr), count(distinct a.addr) from gcrm.s_per_comm_addr as a group by a.comm_medium_cd;
select count(*), count(distinct a.addr) from gcrm.s_per_comm_addr_ph as a;
select count(*), count(distinct a.addr) from gcrm.s_per_comm_addr_ph1 as a;

create table gcrm.phone_counts_per_comm_addr as
select a.addr, count(*) from gcrm.s_per_comm_addr as a where a.comm_medium_cd = 'Phone' group by a.addr;

select count(a.count) from gcrm.email_counts_per_comm_addr as a where a.count = 2;
select count(*) from gcrm.phone_counts_per_comm_addr as a where a.count > 1;



-- Drop table

-- DROP TABLE ndms.ser_rcrepm_tb;

CREATE TABLE ndms.ser_rcrepm_tb (
	repm_cmpn_no varchar(1) NOT NULL,
	repm_corp_no varchar(5) NOT NULL,
	repm_dlr_no varchar(10) NOT NULL,
	repm_ro_no varchar(10) NOT NULL,
	repm_vin varchar(17) NOT NULL,
	repm_cust_no varchar(11) NULL,
	repm_ro_stat varchar(2) NOT NULL,
	repm_estmt_no varchar(10) NULL,
	repm_bkng_no varchar(11) NULL,
	repm_work_type varchar(2) NULL,
	repm_drvr_cust_name varchar(200) NULL,
	repm_milg numeric(8) NOT NULL,
	repm_milg_vrfct_stat varchar(2) NULL,
	repm_estmt_amt numeric(15,2) NULL,
	repm_estmt_go_up_rsn varchar(200) NULL,
	repm_estmt_prmsn_yn varchar(1) NULL,
	repm_work_fnsh_estmt_dtime timestamp NULL,
	repm_work_fnsh_sys_dtime timestamp NULL,
	repm_work_strt_actl_dtime timestamp NULL,
	repm_work_fnsh_actl_dtime timestamp NULL,
	repm_ro_dtime timestamp NULL,
	repm_delay_rsn_code varchar(7) NULL,
	repm_svc_advsr_emp_no varchar(10) NULL,
	repm_tchn_emp_no varchar(10) NULL,
	repm_bill_total_part_amt numeric(15,2) NULL,
	repm_bill_total_labr_amt numeric(15,2) NULL,
	repm_bill_total_othr_amt numeric(15,2) NULL,
	repm_total_labr_amt numeric(15,2) NULL,
	repm_total_part_amt numeric(15,2) NULL,
	repm_total_othr_amt numeric(15,2) NULL,
	repm_tag_no_name varchar(60) NULL,
	repm_no_job_yn varchar(1) NULL,
	repm_pdi_ro_yn varchar(1) NULL,
	repm_vst_type varchar(2) NULL,
	repm_vst_type_seq_no numeric(5) NULL,
	repm_spc_msg_dsctn varchar(50) NULL,
	repm_rmkrs varchar(100) NULL,
	repm_dlr_labr_rate numeric(7,2) NULL,
	repm_cust_dmnd_dfct_cnt numeric(15) NULL,
	repm_cncl_emp_no varchar(10) NULL,
	repm_cncl_dtime timestamp NULL,
	repm_cncl_rsn varchar(200) NULL,
	repm_clse_emp_no varchar(10) NULL,
	repm_clse_dtime timestamp NULL,
	repm_crte_emp_no varchar(10) NULL,
	repm_crte_dtime timestamp NULL,
	repm_updt_emp_no varchar(10) NULL,
	repm_updt_dtime timestamp NULL,
	repm_ropn_rsn varchar(100) NULL,
	repm_ropn_emp_no varchar(10) NULL,
	repm_ropn_dtime timestamp NULL,
	repm_ropn_cnt numeric(15) NULL,
	repm_prvs_milg numeric(8) NULL,
	repm_final_stat varchar(1) NULL,
	repm_sr_num varchar(64) NULL,
	repm_final_date varchar(8) NULL,
	repm_reopen_cnt numeric(15) NULL,
	repm_pdi_cust_no varchar(11) NULL,
	repm_byng_no varchar(10) NULL,
	repm_used_flag varchar(1) NULL,
	repm_byng_dlr_code varchar(5) NULL,
	repm_qk_svc varchar(10) NULL,
	repm_ins_com varchar(5) NULL,
	repm_mob_svc varchar(10) NULL,
	repm_pdi_remarks varchar(550) NULL,
	repm_pick_drop varchar(20) NULL,
	repm_dry_wash varchar(10) NULL,
	repm_ers varchar(1) NULL,
	repm_none varchar(1) NULL,
	repm_additional_confrm varchar(1) NULL,
	repm_non_gen_acc varchar(1) NULL,
	repm_high_watt_bulb varchar(1) NULL,
	repm_high_watt_amplifier_wofer varchar(1) NULL,
	repm_non_gen_cng_lpg varchar(1) NULL,
	repm_local_fuel_rail_nut varchar(1) NULL,
	repm_loose_wiring_routing varchar(1) NULL,
	repm_high_watt_horn varchar(1) NULL,
	repm_non_gen_fog_lamps varchar(1) NULL,
	repm_no_details varchar(1) NULL,
	repm_non_gen_remark varchar(200) NULL,
	repm_wa_flag varchar(1) NULL,
	repm_ro_stat_new varchar(5) NULL,
	repm_be_upt_flg varchar(1) NULL,
	repm_srat_a varchar(5) NULL,
	repm_srat_b varchar(5) NULL,
	repm_srat_c varchar(5) NULL,
	repm_srat_d varchar(5) NULL,
	repm_srat_e varchar(5) NULL,
	repm_srat_f varchar(5) NULL,
	repm_work_category varchar(5) NULL,
	repm_complaint_count varchar(5) NULL,
	repm_door_step varchar(1) NULL,
	repm_proc_stat varchar(2) NULL,
	repm_proc_date timestamp NULL,
	repm_delay_rsn_rmkrs varchar(1000) NULL,
	repm_delay_rsn_date timestamp NULL,
	repm_surv_name varchar(50) NULL,
	repm_rpir_type varchar(2) NULL,
	repm_rpir_panl_cnt numeric(7,2) NULL,
	repm_rplc_panl_cnt numeric(7,2) NULL,
	repm_cust_wait varchar(2) NULL,
	repm_fi_start_dtime timestamp NULL,
	repm_fi_end_dtime timestamp NULL,
	repm_qc_inspt_no varchar(10) NULL,
	repm_wash_start_dtime timestamp NULL,
	repm_wash_end_dtime timestamp NULL,
	repm_wash_advsr_no varchar(10) NULL,
	repm_wash_remark varchar(256) NULL,
	repm_dlr_code varchar(5) NULL,
	repm_exit_milg numeric(8) NULL,
	repm_file_doc_id varchar(30) NULL,
	repm_atof_rslt_no varchar(11) NULL,
	repm_fi_stat varchar(2) NULL,
	repm_wash_stat varchar(2) NULL,
	CONSTRAINT ser_rcrepm_tb_tmp_fulldata_pkey PRIMARY KEY (repm_cmpn_no, repm_corp_no, repm_dlr_no, repm_ro_no)
);

copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_1.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_2.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_3.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_4.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_5.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_6.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_7.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_8.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_9.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_10.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_11.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_12.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_13.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_14.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_15.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_16.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_17.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_18.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_19.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_20.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_21.csv' delimiter '|' quote '"' csv header;


copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_22.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_23.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_24.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_25.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_26.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_27.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_28.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_29.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_30.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_31.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_32.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_33.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_34.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_35.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_36.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_37.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_38.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_39.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_40.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_41.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_42.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_43.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_44.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_45.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_46.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_47.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_48.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_49.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_50.csv' delimiter '|' quote '"' csv header;
copy ndms.ser_rcrepm_tb from 'D:/NDMS/ser_rcrepm_tb_data/ser_rcrepm_tb_data_51.csv' delimiter '|' quote '"' csv header;


--creating a small s_camp_con with 11 useful columns for only 16 final email campaigns 
create table s_camp_con_16 as select row_id,src_id,batch_num,camp_con_num,camp_ld_wave_id,con_per_id,dcp_id,msg_bncd_reason_cd,msg_bncd_stat_cd,prsp_con_per_id,stat_cd from gcrm.s_camp_con as a where a.src_id in ('1-QAA78U','1-1F2I7QH','1-17OVJ5H','1-1EDYJB6','1-1FGSQR5','1-1FZ04OB','1-VYE9WV','1-RUISW7','1-ANFRFX','1-P3CLPH','1-G5QMCP','1-U7XQH9','1-154L44P','1-HLQOFL','1-AXH9AX','1-T1YOOF','1-HH7IWN');

select a.row_id, a.ou_num, a.par_row_id from s_org_ext as a where a.alias_name = 'Popular Hyundai';

select count(distinct a.divn_type_cd) from s_org_ext as a where a.ou_num in ('W4404','N3436','S4232','W5216','E7A00','W3808','S5426','S4812','S4801','S7433','N3238','N2616','E4408','S8406','N6610','S4823','E4226','S5231','W3531','W2247','N4816','S8A01','S1200','W6400','W3504','S8202','W2531','N3232','S7225','N1210','S4702','S1413','S5A00','W2230','N2204','E4812','E1810','W5208','S5433','S5801','E4212','N2423','W2827','E1401','S1211','E3406','S5437','E4221','N8805','E6804','E6803','N4410','N3220','S5436','E4705','S7234','N2508','E6409','N3719','S5428','E6222','E7208','N2230','E1809','S8604','S7207','N1401','N2807','E4215','N3266','W5608','S8818','N3262','N2602','E1705','S8812','S5233','N3802','N6206','E7809','W2804','E7805','N3522','N6217','W3414','W2829','W1B01','E1608','N4210','E6524','S7206','S8218','E6214','N3414','W5417','N4204','E6225','N2212','E7200','S8408','W3246','W5808','N3242','W5804','S1410','N1420','W2812','N3422','S5815','N2220','N3521','W5718','S7227','W1801','N3815','N4416','N1432','N5804','S7712','N3443','N1B00','S8808','S4230','S8607','W3224','E4806','N3428','S5441','N2213','S7212','W2229','N2411','N6224','S8416','N2804','W3803','W3703','W4201','N2228','S7A03','E1200','S5425','N3231','W5210','W4401','S1400','N5210','S5438','N3202','N2803','W3817','E7702','S7706','N4820','S7606','S7813','S7816','S4201','N6812','N3427','N4515','S4222','N6820','E3200','N4801','W3237','E4201','N3265','N3806','E1223','S5710','E6223','S7236','N2210','W3212','N2809','S4527','N3801','N3260','N7200','S5708','S5713','S4210','E4801','N6422','N2238','S8413','E6413','N6419','W3526','W5416','N3210','S8229','S4822','S5225','N6209','S5229','E5221','S5223','S4221','E5223','N2415','S8414','S1207','E4216','N1207','S8A00','N3518','N3425','W5214','S8214','W2824','W3216','N8202','W2248','S7732','W3227','N1220','W2605','N1A03','S5217','N4803','N4822','N4805','N1440','E6404','W3718','N2236','W2831','S7734','E1212','W6602','W2237','N1211','S5806','W2709','E1205','N3508','N2202','S8809','S4824','E7804','N6A05','S7818','E3202','W3820','N3410','W5236','W5A03','E1221','W3716','S5826','W5814','W2241','W2802','S5409','W2821','W2532','N1403','N2806','N3821','W2414','E6200','E6809','N1216','E1217','W5807','N3227','S7408','E6607','N2812','S5814','N1431','N3A06','N2233','N3433','S7819','S7216','S7424','S4814','W1409','S4229','S8411','S1212','E4535','N2211','W3812','S7411','S7438','N4419','N3532','W3217','N4413','E6808','W3247','N6807','S8815','E4816','W3806','E1802','S8804','S7812','N7203','N4509','E4224','S2200','N6817','S4407','W1218','W2218','W3403','N6A07','N2205','W2232','N4412','S1412','N3804','N4407','S8225','W3810','W3532','N4A05','N4514','N3809','E1410','N3215','S7202','E4802','S4415','N2802','E4814','E1219','S7417','N2214','S4404','S7218','N3405','W5209','W2604','N1223','E3506','S8705','E7207','N3237','E2201','W5223','W2251','N1224','N6228','W1523','N4231','N4224','W1201','W3610','N2232','E1220','N3223','N5403','N3247','W3811','N2511','W3608','S8423','S7238','E4606','S5208','N2811','W2223','N5204','S8816','N3710','N3259','S7211','W5226','W2213','N4A03','N8203','W5215','W2217','W1530','W5225','W2240','W2819','N6802','S7230','W5515','W5233','N3234','S4811','W2809','E7810','N2810','E1405','E4518','E6811','S4804','N3416','E4808','W2201','W3510','S5805','N3609','S1209','E6418','W2528','W3512','E4706','S5810','N3205','E4223','E6701','W1528','S8219','W3213','N2614','W3228','N3256','S5417','N1531','W3A09','N4225','N8207','N6225','E1404','S7823','N3526','N2208','S7221','S5816','S5420','W2535','E6226','N1446','S4224','W3431','N1528','N3267','S7A09','S4225','W2609','N6221','E4209','S8A08','S7820','N4810','N8801','W1532','N4203','S5811','N8204','N6219','E5222','S4528','S8817','N6608','N4219','W3436','S7232','N2521','N3807','E1202','E1225','E6211','W2533','W6200','N1448','N6603','E6204','W3405','N3255','E6220','E7807','S7616','W1202','W5219','W2203','W2703','N4821','S7233','W2816','S4525','N6218','N3A10','S7219','N3808','E7210','W3424','N6412','S5703','N3249','S8420','N3520','N4222','S8404','S5205','S4220','W3530','N3715','N1B01','E7211','S7817','N6616','N8506','W3410','S7811','S4818','S8417','W2701','N7204','E4405','W5232','S4816','N1215','S8223','N3251','W3A06','W1212','S7741','N4406','E3400','W2252','W3529','N2201','S4234','W2250','S8424','W3A07','W5816','N6232','N6806','N2704','W2255','W2236','W2832','W2815','N6421','E1215','N3818','E6802','N6810','E4213','N8802','S7437','S4820','S8822','S5A05','N2218','W3829','N2413','S8410','E4603','S1405','S5A01','W6403','S7412','N2515','N3439','N5206','N2229','S7735','E6814','N1217','S4202','S5412','W3230','N6411','W3827','E3201','S8819','W2238','E6815','N1415','N4414','W5819','N1413','S8412','S5221','S7220','N3420','E1806','W3238','S7410','W2249','S7505','N6216','E1807','S4708','W3242','W3708','E3401','N1227','W5235','N1218','N2408','E6518','S7807','N8806','N4812','E4219','N2814','W2811','N6814','S8425','W2216','S7810','N6A04','E6407','E4220','N1A00','N3253','N6220','N3250','W3215','E6707','S5429','W1520','W2207','S8813','E1408','W5414','E6224','N3224','W3828','S5819','W2805','N3402','S7814','S4209','S5206','S5216','S4815','W3245','N3814','W2423','N3712','S4216','E5801','W3428','S4231','S4405','E7408','S5210','N1543','N4212','W3815','S4212','E1412','W2253','S5807','N4815','W3225','E7205','S7413','W2235','E3408','W3432','E6218','W3503','W3204','N3216','S4805','E6217','N8804','W2224','E6412','N4218','S1414','S5802','S5222','W3214','S5212','W1210','W2710','S5808','E6206','E1213','N3431','S8704','W5704','N3411','W1220','S8807','W3220','W5709','N5401','N3525','S4821','W5801','W2530','N5205','W3232','N3252','N3708','N3201','W2202','N4232','S4526','W3433','N3432','N2222','W2A02','N4817','S5705','W3823','W5222','N6235','S5201','N4813','E6812','N8809','S8805','N6223','W5213','W3434','N4229','S7228','W2426','E7703','W5231','S8211','W3715','S4808','W5701','E6414','E7811','S7215','N2815','S7205','W2424','W5227','W2803','W6402','S7226','N1213','N3208','S5442','N6811','W5220','W2242','S7736','W5217','E1508','W4405','W3241','W5810','W2817','W3A03','W3427','N3213','S5407','N6819','W5202','N3813','W3206','S7503','E7212','W2254','S8403','E6205','W2516','S1201','N2708','N1225','N3222','N6236','S8402','E6202','S8821','W2834','N4824','N1219','S4819','S4214','N6813','N3413','W3208','N2808','S8814','N6200','N3A12','W2801','N3A02','E7802','S5228','W2411','W5812','W3528','W2527','W5609','W2239','S5427','N3A01','S4809','N3245','N4607','S5200','S8226','S8217','W2806','W3824','N3812','S7621','W5218','N8803','W1216','E7808','N5701','N3440','N4227','S8434','S8811','N2203','S1210','W2222','S5812','N3258','S4614','W3527','S8230','S8409','W3822','N4228','W1B00','S5227','W3616','W5228','N1221','N8208','E4227','N4701','W3825','N6233','W3426','E4809','S4203','N4814','W2244','N1443','W3201','S7210','N3614','N1226','W3819','E1203','W5204','S5234','W2257','E4218','W5805','N3264','N6229','E4803','N6A06','W2818','N1411','N5202','N2216','S4806','E6602','N3611','N4808','W3239','N2209','N3221','S8606','S5A04','E6810','W3229','E1207','E6817','N1200','N1445','N6423','S7825','W5A01','S8227','W2830','N1208','S5818','N2237','N2235','S5431','N4211','E5224','W1414','N7202','W1219','N1201','W2705','W5205','S8426','S7426','N5208','E4210','E1703','W2233','E7206','E7806','W3814','W1533','E4229','W3200','W5415','N3A11','S5209','N4A02','N6809','W3809','W1213','S4226','N6215','W3417','W3235','N6815','N3229','S4606','W5815','W2406','N8808','W2204','W6201','N3246','N6226','E7204','W3430','S5230','N3239','S5825','N4819','S5821','S8806','S5435','E1804','N3817','W5711','N2702','N6805','S4825','E6210','N6816','S8213','W2526','N3811','N3228','E4207','E6212','N1441','S5712','S7610','S8422','N2701','N6804','E1209','W3406','N3261','S1402','S8407','W3522','S5232','N6415','W3423','W5409','W2256','N4220','S7740','E6517','W3226','S7239','N1541','W3425','S1411','S5408','N7201','W5813','S7821','W5803','E6201','N3429','E7201','W2706','S7204','N8602','S7235','S8428','N4233','N3243','W2825','N6237','E4807','S8A09','N3445','S4504','N4209','N5203','S1208','S5803','W2826','S8231','N4606','E6807','W5229','N3703','W3231','E6801','S7702','N3254','S5423','N6214','N8507','W5809','S8212','E7801','N3207','S8221','N3418','N5207','N2219','N4818','N4213','E1208','S7A04','E7203','S7613','N6818','N2225','E6805','N3722','N4202','N4807','N4230','S5813','W2416','W3714','E4228','S8210','S4810','E4521','N3423','E1803','E4412','S5422','E1406','S5434','W2221','S5207','N1222','S5215','S8209','W5230','W5820','W3821','N2234','W5212','N3441','S7419','N6822','E4225','S5202','E4811','W1401','N3820','E7213','N4811','W2228','W2828','N6604','S7603','E7405','N2215','S1418','S7612','N6208','W2810','N2200','W2525','E1411','W3211','E4410','W5818','W5607','S4233','N4707','N3244','N6204','S8810','W2246','S4826','N3235','E6203','W2422','N4226','W5A04','S7224','N3533','E4231','W3807','W2226','W3816','S8419','N3716','W2214','S8232','E1214','W3524','N3263','S8803','S5611','E6806','N3217','S1417','W3813','N2206','N3605','N2705','S1409','S7802','W6800','N2226','S8224','S5415','E6408','N3816','W3240','W3818','S8820','N4221','E6221','E1812','S8205','S5220','N6821','S4615','W5237','W1410','E7202','N6230','S4817','W1203','E6411','E7409','W5224','S5A07','N4214','S8707','E4409','W5221','E4413','S4807','E1216','W1416','S8A02','W5606','W2234','S4411','E1201','S8233','S4703','S8427','E4230','N6234','S5706','E6209','N2419','E1605','S4215','N2227','S4235','N3615','S7422','N2217','W2820','S1100','N3726','S5226','S4611','E6219','N3248','W3243','S7815','S5809','N3805','N3200','W3830','S8200','N2223','N3437','S7809','N2801','N4516','N4825','E4222','W3418','W1A01','E4200','N8807','W3244','E1218','W5234','W3421','N3212','N3257','W3222','S1205','S8228','N4223','N3230','S4227','N3612','N8210','S8421','S7619','W4200','S1206','W2212','E1210','E4604','N4234','E7602','W2823','S8222','S5213','W5802','S1A02','N1405','N3527','E7803','E4815','S5224','N8209','N6808','W2814','W2A06','W6A00','W3826','S5219','N3417','E4805','W3218','S8609','N3206','W3203','S5211','S7801','W5506','N1444','W2813','N4703','W3234','S5235','N5209','S7237','E1224','S7615','W2822','S8216','S1408','E4214','W3805','N6231','S8220','N4216','N8206','E6711','N5211','N3438','S4813','W2702','W1417','S7231','W2243','S5717','N4809');

select count(distinct b.dlr_ou_id) from gcrm.s_org_ext as a, gcrm.s_vhcl_sales as b where a.row_id = b.dlr_ou_id; 

select count(distinct b.dlr_ou_id) from gcrm.s_org_ext as a, gcrm.s_vhcl_sales as b where a.ou_num = b.repm_dlr_no; 

select count(distinct b.repm_dlr_no) from gcrm.s_org_ext as a, ndms.ser_rcrepm_tb_data as b where a.ou_num = b.repm_dlr_no; 

slect from s_src as a where a.row_id = ''

select
	a.ou_num,
	b.divn_type_cd
from
	gcrm.s_org_ext a,
	gcrm.s_org_ext b
where
	a.row_id = b.par_divn_id
	and b.divn_type_cd is not null;
	
--To find the number of dealers till date, 2430
select
	count(distinct a.ou_num)
from
	gcrm.s_org_ext a,
	gcrm.s_org_ext b
where
	a.row_id = b.par_divn_id
	and b.divn_type_cd is not null;

select * from gcrm.our_src as a where a.camp_name_for_disp like 'FCCC Ex%';


select count(*), count(a.per_id), count(distinct a.per_id), count(a.asset_id), count(distinct a.asset_id) from gcrm.sms_contacts_4 as a where a.sms_campaign_name = 'FCCC_AllRegionsExceptSRO4_3rdYear&AboveCustomers_April2017';

CREATE TABLE gcrm.sms_contacts_5 AS
SELECT
	a.*,
	b.old_camp_id,
	b.new_camp_id,
	b.channel_clubbed,
	b.new_campaign_disp_name,
	b.region,
	b.campaign_type,
	b.camp_sub_cat,
	b.prog_start_dt_new,
	b.prog_end_dt_new
FROM
	gcrm.sms_contacts_4 AS a
LEFT OUTER JOIN gcrm.our_src2 AS b ON
	a.sms_campaign_name = b.old_campaign_name;

select a.channel_clubbed, count(*), count(distinct a.channel_clubbed) from gcrm.sms_contacts_5 as a group by a.channel_clubbed;

select a. from gcrm.sms_contacts_4 as a;

select * from sms_contacts_5 as a where a.sms_campaign_name like 'Wom%';

create table gcrm.sms_contacts_6 as
select
	a.new_camp_id,
	a.old_camp_id,
	a.channel_clubbed,
	a.per_id,
	a.asset_id,
	a.new_campaign_disp_name,
	a.sms_campaign_name,
	a.campaign_type,
	a.sms_mobile,
	a.sms_month,
	a.sms_year,
	a.prog_start_dt_new,
	a.prog_end_dt_new
from
	gcrm.sms_contacts_5 as a;

select count(a.per_id), count(distinct a.per_id) from gcrm.sms_contacts_6 as a;

select count(distinct a.sms_mobile) from gcrm.sms_contacts_4  as a;

create table gcrm.sms_cont_vin_7 as select a.*, b.asset_num from gcrm.sms_contacts_6 as a left outer join gcrm.s_asset as b on a.asset_id = b.row_id;

select count(a.per_id), count(distinct a.per_id), count(a.asset_id), count(distinct a.asset_id), count(a.asset_num), count(distinct a.asset_num) from gcrm.sms_cont_vin_7 as a;

select count(distinct a.old_camp_id), count(distinct a.sms_campaign_name), count(distinct a.new_campaign_disp_name) from gcrm.sms_cont_vin_7 as a;

--create table gcrm.sms_camp_per_id_count as select a.new_camp_id, a.per_id, a.sms_mobile, count(a.per_id) from gcrm.sms_cont_vin_7 as a group by 1, 2, 3;

--select a.new_camp_id, a.new_campaign_disp_name, count(a.sms_mobile), count(distinct a.sms_mobile), count(a.per_id), count(distinct a.per_id),  count(a.asset_num), count(distinct a.asset_num) from gcrm.sms_cont_vin_7 as a group by 1, 2;

CREATE TABLE gcrm.most_final_fact_email (
              camp_id varchar(15) NULL,
              contact_id varchar(15) NULL,
              vin varchar(100) NULL,
              asset_id varchar(15) NULL,
              prog_start_dt date NULL,
              prog_end_dt date NULL,
              camp_name varchar(100) NULL,
              channel_name text NULL,
              old_camp_id varchar(20) NULL,
              new_camp_id varchar(20) NULL,
              new_campaign_disp_name varchar(100) NULL,
              prog_start_dt_new timestamp NULL,
              prog_end_dt_new timestamp NULL,
              channel_clubbed varchar(20) NULL
);

copy gcrm.most_final_fact_email from 'D:/Aravindh/most_final_fact_email_201911280944.csv' delimiter ',' quote '"' csv header;

--25500426, 5438066 (Email both), 20062360 (SMS Both)
create table gcrm.both_details as
select
	b.old_camp_id,
	b.new_camp_id,
	b.new_campaign_disp_name,
	b.contact_id,
	b.asset_id,
	b.vin,
	b.prog_start_dt_new,
	b.prog_end_dt_new,
	b.channel_clubbed,
from
	gcrm.most_final_fact_email as b
union all
select
	a.old_camp_id,
	a.new_camp_id,
	a.new_campaign_disp_name,
	a.per_id as contact_id,
	a.asset_id,
	a.asset_num as vin,
	a.prog_start_dt_new,
	a.prog_end_dt_new,
	a.channel_clubbed,
	'SMS' as channel_name
from
	gcrm.sms_cont_vin_7 as a
where
	a.channel_clubbed = 'Both';

create table gcrm.both_details_count as select a.new_camp_id, a.new_campaign_disp_name, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.both_details as a group by 1, 2;

--17088796
create table gcrm.both_dist_camp_perid AS SELECT distinct a.new_camp_id, a.contact_id FROM gcrm.both_details as a;

--18264778
create table gcrm.both_details2 as select distinct b.new_camp_id, b.new_campaign_disp_name,	b.contact_id, b.asset_id, b.vin, b.prog_start_dt_new, b.prog_end_dt_new, b.channel_clubbed from	gcrm.both_details as b where CONTACT_ID is not null;

--sms only with contact ids not null, 
create table gcrm.sms_only3 as select distinct a.new_camp_id, a.new_campaign_disp_name, a.contact_id, a.asset_id, a.vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_only1 as a where a.contact_id is not null;

--all three types with contact ids not null, 56160210
create table public.all_three1 as
select a.new_camp_id, a.new_campaign_disp_name, a.contact_id, a.asset_id, a.vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.both_details2 as a
union all
select b.new_camp_id, b.new_campaign_disp_name, b.contact_id, b.asset_id, b.vin, b.prog_start_dt_new, b.prog_end_dt_new, b.channel_clubbed from gcrm.sms_only3 as b
union all
select c.new_camp_id, c.new_campaign_disp_name, c.contact_id, c.asset_id, c.vin, c.prog_start_dt_new, c.prog_end_dt_new, c.channel_clubbed from gcrm.really_again as c;

create table gcrm.all_three1_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from public.all_three1 as a group by 1, 2;

--all three where asset ids and vins are not null, vin null check only is enough, 43978714
create table gcrm.all_three2 as select * from public.all_three1 as a where a.vin is not null;
create table gcrm.all_three2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from gcrm.all_three2 as a group by 1, 2;

--22937
CREATE TABLE gcrm.g3_ocmv_exclutionlist (
	contact_id varchar(15) NULL
);

copy gcrm.g3_ocmv_exclutionlist from 'C:/Users/2003966/Desktop/HAEI/Analysis/Campaign/New table scripts/g3_ocmv_exclutionlist_201911221103.csv' delimiter ',' quote '"' csv header;

--all three, leaving exclusion list, 42129869
create table gcrm.all_three3 as select * from gcrm.all_three2 as a where a.contact_id not in (select b.contact_id from gcrm.g3_ocmv_exclutionlist as b);
create table gcrm.all_three3_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist  from gcrm.all_three2 as a group by 1, 2;

--5838877 (before count 18182000 + 5838877)
delete from gcrm.ser_rcrepm_tb_4yr as a where extract(year from a.repm_ro_dtime) = 2016;

select a.repm_work_type, count(*), sum(a.repm_bill_total_labr_amt+a.repm_bill_total_othr_amt+a.repm_bill_total_part_amt) as total_sales_amount from gcrm.ser_rcrepm_tb_4yr as a where a.repm_work_type in ('RR','FS','PS') group by 1;
select a.repm_work_type, count(*), sum(a.repm_bill_total_labr_amt) as amt1, sum(a.repm_bill_total_othr_amt) as amt2, sum(a.repm_bill_total_part_amt) as amt3 from gcrm.ser_rcrepm_tb_4yr as a where a.repm_work_type in ('RR','FS','PS') group by 1;

--42319551
create table gcrm.all_three_fact1 as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	up1.repm_ro_dtime,
	(up1.repm_bill_total_labr_amt + up1.repm_bill_total_othr_amt + up1.repm_bill_total_part_amt) as total_sales_amount,
	up1.repm_work_type,
	up1.repm_ro_no,
	up1.repm_dlr_no
from
	gcrm.all_three3 as mi
left outer join gcrm.ser_rcrepm_tb_4yr as up1 on
	up1.repm_vin = mi.vin
	and date(up1.repm_ro_dtime) between mi.prog_start_dt_new and mi.prog_end_dt_new
	and up1.repm_work_type in ('RR',
	'FS',
	'PS');

create table gcrm.all_three_fact1_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist, count(a.repm_ro_no) as ro_count, count(distinct a.repm_ro_no) as ro_dist, count(a.total_sales_amount) as totamt_cnt, count(nullif(a.total_sales_amount,0)) as ro_non0_cnt, sum(a.total_sales_amount) as total_ro_val  from gcrm.all_three_fact1 as a group by 1, 2;


select count(*) from gcrm.bz_send_log as a;
--4800703
create table gcrm.all3_dist_vins as select distinct a.vin from gcrm.all_three_fact1 as a;


--42129869
create table gcrm.all_three_fact2 as
select
	distinct mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	sum(mi.total_sales_amount) as total_sales_amount,
	count(repm_ro_no) as ro_count,
	(case
		when count(mi.repm_ro_no) > 0 then 1
		when count(mi.repm_ro_no) <= 0 then 0
	end ) as bin_ro
from
	gcrm.all_three_fact1 as mi
group by
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new;

create table gcrm.all_three_fact2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist, count(a.total_sales_amount) as totamt_cnt, count(nullif(a.total_sales_amount,0)) as ro_non0_cnt, sum(a.total_sales_amount) as total_ro_val  from gcrm.all_three_fact2 as a group by 1, 2;

--sum(ro_count), sum(ro_bin)
create table gcrm.all_three_fact2_count2 as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist,	count(a.vin) as vin, count(distinct a.vin) as vin_dist, sum(ro_count) as tot_ro_count, sum(bin_ro) as ind_ro, sum(a.total_sales_amount) as total_ro_val from gcrm.all_three_fact2 as a group by 1, 2;

--------------------------------- Deepa -----------------------------------------------------
--42319551
create table gcrm.all_three_fact1_deepa as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	up1.repm_ro_dtime,
	(up1.repm_bill_total_labr_amt + up1.repm_bill_total_othr_amt + up1.repm_bill_total_part_amt) as total_sales_amount,
	up1.repm_work_type,
	up1.repm_ro_no,
	up1.repm_dlr_no,
	(case 
		when up1.repm_work_type ='RR' then 1
		else 0
	end ) as ind_rr,
	(case 
		when up1.repm_work_type ='FS' then 1
		else 0
	end ) as ind_fs,
	(case 
		when up1.repm_work_type ='PS' then 1
		else 0
	end ) as ind_ps
from
	gcrm.all_three3 as mi
left outer join gcrm.ser_rcrepm_tb_4yr as up1 on
	up1.repm_vin = mi.vin
	and date(up1.repm_ro_dtime) between mi.prog_start_dt_new and mi.prog_end_dt_new
	and up1.repm_work_type in ('RR',
	'FS',
	'PS');

--42129869
create table gcrm.all_three_fact2_deepa as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	sum(mi.total_sales_amount) as total_ro_amount,
	count(repm_ro_no) as ro_count,
	(case
		when count(mi.repm_ro_no) > 0 then 1
		else 0
	end ) as bin_ro,
	max(ind_rr) as ind_rr,
	max(ind_ps) as ind_ps,
	max(ind_fs) as ind_fs,
	sum(ind_rr) as rr_count,
	sum(ind_ps) as ps_count,
	sum(ind_fs) as fs_count
from
	gcrm.all_three_fact1_deepa as mi
group by
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new;

select * from gcrm.all_three_fact1_deepa;
select * from gcrm.all_three_fact2_deepa;

--QC Check
select count(a.*) from
gcrm.all_three_fact2_deepa a where contact_id not in (select distinct contact_id from gcrm.contact_analysis_master_2);

--Fact with Contact
----42129869
drop table gcrm.fact_contact;
create table gcrm.fact_contact as
select fact.*, con.con_cd, con.sex_mf, con.city as city_code from gcrm.all_three_fact2_deepa fact
left outer join gcrm.contact_analysis_master_2 con
on fact.contact_id=con.contact_id;

--Fact_contact with campaign type;
drop table gcrm.fact_contact_camptype;
create table gcrm.fact_contact_camptype as
select fact.*, camp.campaign_type from gcrm.fact_contact fact
left outer join gcrm.our_s_src camp
on fact.new_camp_id=camp.new_camp_id;

--Camps & Events -- 32569421
create table fact_camp_events as
select * from fact_contact_camptype
where campaign_type = 'Camps & Events';

--Excluding extreme RO values based on the car model and RO value
--Creating fact_camp_events2 with model column, 32569425
create table gcrm.fact_camp_events2 as select a.*, b.model_cd from gcrm.fact_camp_events as a left outer join gcrm.s_asset as b on a.vin = b.asset_num;
--149
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 200000;
--141
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 150000 AND a.total_ro_amount < 200000 AND a.model_cd IN ('New Verna','i20','Grand i10','Verna','Xcent','Santro','i10','New i20','Creta','Accent','Sonata','Getz','New Sonata','i20 Active','Eon');
--214
delete from gcrm.fact_camp_events2 as a where a.total_ro_amount >= 100000 AND a.total_ro_amount < 150000 AND a.model_cd IN ('Grand i10','Xcent','Santro','i10','Accent','Getz','Eon');
--(32569425-149-141-214) = 32568921

--removing and updating SMS12 records in fact_camp_events2 
--2443705
delete from gcrm.fact_camp_events2 as a where a.new_camp_id = 'SMS12';
--2443710
copy gcrm.fact_camp_events2 from 'D:/sms12_5/sms12_5.csv' delimiter ',' quote '"' csv header;

create table gcrm.fact_camp_events2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist, count(a.total_ro_amount) as totamt_cnt, count(nullif(a.total_ro_amount,0)) as ro_non0_cnt, sum(a.total_ro_amount) as total_ro_val  from gcrm.fact_camp_events2 as a group by 1, 2;



-----------------------------
--  4th Dec 2019
-- To address the data issue , one vin mapped to multiple contacts 
---------------------------------

create table gcrm.all3_vin_cont_count as 
select a.new_campaign_disp_name, a.vin, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as dist_cont from gcrm.all_three3 as a group by 1, 2;

create table gcrm.all3_vin_cont_count2 as select a.*, 
(case 
when row_count = 1 then '1-1'
when row_count = 2 then '2-2'
when row_count = 3 then '3-3'
when row_count = 4 then '4-4'
when row_count = 5 then '5-5'
when row_count = 6 then '6-6'
when row_count = 7 then '7-7'
when row_count = 8 then '8-8'
when row_count = 9 then '9-9'
when row_count >9 then 'ge10'
end) as bin
from gcrm.all3_vin_cont_count as a;

create table gcrm.all3_vin_cont_count3 as 
select a.new_campaign_disp_name, a.bin, count(*) from gcrm.all3_vin_cont_count2 as a group by 1,2;

select * from gcrm.all3_vin_cont_count3;

create table gcrm.fact_camp_events_2 as
select a.* , b.bin

from gcrm.fact_camp_events a 
left outer join gcrm.all3_vin_cont_count2 b on a.new_campaign_disp_name =b.new_campaign_disp_name and a.vin = b.vin;


select a.*  from gcrm.fact_camp_events a 
where channel_clubbed = 'SMS only'
order by a.new_camp_id, a.vin ;

select a.*  from gcrm.fact_camp_events a 
where channel_clubbed = 'SMS only' and vin in ('MALBB51RLDM524165','MALBM51BLGM266491','MALBM51RLHM456974','MALC181RLHM331914','MALC841DLHM014391','MALCU41ULBM013385','MALCU41ULCM063097','MALCU41ULCM068350','MALCU41ULDM115596','KMHNM81XR5U169897','MALA151ALBM028281','MALA151ALDM257158','MALA151ALFM369649')
order by a.new_camp_id, a.vin ;

select * from gcrm.all3_vin_cont_count2 a where  a.contact_id >5;


------------------------------------------------------------------------------------------------------------------------------
--sms_cont_vin_7 where mobile num is not null, whereas contact_id is null, mobile nums with no per ids
create table gcrm.sms_7_null_cnt1 as select a.new_camp_id, a.new_campaign_disp_name, count(*) from gcrm.sms_cont_vin_7 as a where a.sms_mobile is not null and a.per_id is null group by 1, 2;

--sms_cont_vin_7 where contact_id is not null, whereas asset_id is null, contacts with no asset
create table gcrm.sms_7_null_cnt2 as select a.new_camp_id, a.new_campaign_disp_name, count(*) from gcrm.sms_cont_vin_7 as a where a.per_id is not null and a.asset_id is null group by 1, 2;




--101
create table gcrm.sms_contacts_count as select a.sms_filename, a.sms_month, a.sms_year, count(a.sms_mobile) from gcrm.sms_contacts as a group by 1, 2, 3;

create table gcrm.sms_contacts_4a as select distinct a.sms_campaign_name, a.sms_mobile from gcrm.sms_contacts_4 as a;
create table gcrm.sms_contacts_4b as select a.*, b.per_id from gcrm.sms_contacts_4a as a left outer join gcrm.s_per_comm_addr_ph1 as b on a.sms_mobile = b.addr;
select distinct a.new_campaign_disp_name, a.old_campaign_name, a.channel_clubbed from gcrm.our_src2 as a;
create table gcrm.sms_contacts_4b_count as select a.sms_campaign_name, count(a.sms_mobile) as mob_count, count(distinct a.sms_mobile) as mob_dist, count(a.per_id) as per_count, count(distinct a.per_id) as per_dist from gcrm.sms_contacts_4b as a group by 1;

--sms only with contact ids, asset ids and vins not null
create table gcrm.sms_only4 as select distinct a.new_camp_id, a.new_campaign_disp_name, a.contact_id, a.asset_id, a.vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_only3 as a where a.vin is not null;

select
	new_camp_id,
	new_campaign_disp_name,
	count(*),
	count(contact_id),
	count(distinct contact_id),
	count(vin),
	count(distinct vin)
from
	gcrm.both_details2
group by
	1,
	2;

--
create table gcrm.both_details3 as
select
	distinct a.*,
	1 as email_ind
from
	gcrm.both_details2 as a
left outer join gcrm.both_details as b on
	a.new_camp_id = b.new_camp_id
	and a.contact_id = a.contact_id
where
	b.channel_name = 'EMAIL';


create table gcrm.both_details3 as select distinct a.*,	1 as email_ind from gcrm.both_details2 as a left outer join gcrm.most_final_fact_email as b on a.new_camp_id = b.new_camp_id and a.contact_id = a.contact_id;


--18115171
create table gcrm.most_final_fact_sms as select * from gcrm.both_details as a where a.channel_name = 'SMS' and a.contact_id is not null;

create table gcrm.both_details4 as select distinct a.*, 1 as sms_ind from gcrm.both_details3 as a left outer join gcrm.most_final_fact_sms as b on a.new_camp_id = b.new_camp_id and a.contact_id = a.contact_id;

-- checks
select new_camp_id, new_campaign_disp_name, vin , count(*)
from gcrm.both_details2 
group by 1,2,3
having count(*) >1;

CREATE TABLE gcrm.sms_6_counts AS select a.new_camp_id, a.new_campaign_disp_name, count(*) AS row_count, count(a.sms_mobile) AS mobile_count, count(distinct a.sms_mobile) AS mobile_dist, count(a.per_id) per_id_count, count(distinct a.per_id) per_id_dist, count(a.asset_id) asset_id_count, count(distinct a.asset_id) asset_id_dist from gcrm.sms_contacts_6 as a group by 1, 2;

CREATE TABLE gcrm.sms_7_counts AS select a.new_camp_id, a.new_campaign_disp_name, count(*) AS row_count, count(a.sms_mobile) AS mobile_count, count(distinct a.sms_mobile) AS mobile_dist, count(a.per_id) per_id_count, count(distinct a.per_id) per_id_dist, count(a.asset_id) asset_id_count, count(distinct a.asset_id) asset_id_dist, count(a.asset_num) AS vin_count, count(distinct a.asset_num) AS vin_dist from gcrm.sms_cont_vin_7 as a group by 1, 2;

create table gcrm.sms_only1 as select a.old_camp_id, a.new_camp_id, a.new_campaign_disp_name, a.per_id as contact_id, a.asset_id, a.asset_num as vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_cont_vin_7 as a where a.channel_clubbed = 'SMS only';


--email only with contacts ids not null
CREATE TABLE gcrm.really_again (
       camp_id varchar(15) NULL,
       contact_id varchar(15) NULL,
       vin varchar(100) NULL,
       asset_id varchar(15) NULL,
       prog_start_dt date NULL,
       prog_end_dt date NULL,
       camp_name varchar(100) NULL,
       channel_name text NULL,
       old_camp_id varchar(20) NULL,
       new_camp_id varchar(20) NULL,
       new_campaign_disp_name varchar(100) NULL,
       prog_start_dt_new timestamp NULL,
       prog_end_dt_new timestamp NULL,
       channel_clubbed varchar(20) NULL
);

--6702737
copy gcrm.really_again from 'D:/Aravindh/really_again_email_only_201911281256.csv' delimiter ',' quote '"' csv header;

---------------------------------------------------------------------------------------------------
--2443874
create table gcrm.SMS12_1 as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	'2017-06-04 00:00:00' as prog_start_dt_new,
	'2017-06-05 00:00:00' as prog_end_dt_new,
	up1.repm_ro_dtime,
	(up1.repm_bill_total_labr_amt + up1.repm_bill_total_othr_amt + up1.repm_bill_total_part_amt) as total_sales_amount,
	up1.repm_work_type,
	up1.repm_ro_no,
	up1.repm_dlr_no,
	(case 
		when up1.repm_work_type ='RR' then 1
		else 0
	end ) as ind_rr,
	(case 
		when up1.repm_work_type ='FS' then 1
		else 0
	end ) as ind_fs,
	(case 
		when up1.repm_work_type ='PS' then 1
		else 0
	end ) as ind_ps
from
	gcrm.all_three3 as mi
left outer join gcrm.ser_rcrepm_tb_4yr as up1 on
	up1.repm_vin = mi.vin
	and date(up1.repm_ro_dtime) between '2017-06-04 00:00:00' and '2017-06-05 00:00:00'
	and up1.repm_work_type in ('RR',
	'FS',
	'PS')
where mi.new_camp_id = 'SMS12';


--2443709
create table gcrm.SMS12_2 as
select
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new,
	sum(mi.total_sales_amount) as total_ro_amount,
	count(repm_ro_no) as ro_count,
	(case
		when count(mi.repm_ro_no) > 0 then 1
		else 0
	end ) as bin_ro,
	max(ind_rr) as ind_rr,
	max(ind_ps) as ind_ps,
	max(ind_fs) as ind_fs,
	sum(ind_rr) as rr_count,
	sum(ind_ps) as ps_count,
	sum(ind_fs) as fs_count
from
	gcrm.SMS12_1 as mi
group by
	mi.new_campaign_disp_name,
	mi.new_camp_id,
	mi.vin,
	mi.channel_clubbed,
	mi.asset_id,
	mi.contact_id,
	mi.prog_start_dt_new,
	mi.prog_end_dt_new;


--Fact with Contact
----2443709
drop table gcrm.fact_contact;
create table gcrm.SMS12_3 as
select fact.*, con.con_cd, con.sex_mf, con.city as city_code from gcrm.SMS12_2 fact
left outer join gcrm.contact_analysis_master_2 con
on fact.contact_id=con.contact_id;

--Fact_contact with campaign type;
--2443709
drop table gcrm.fact_contact_camptype;
create table gcrm.SMS12_4 as
select fact.*, camp.campaign_type from gcrm.SMS12_3 fact
left outer join gcrm.our_s_src camp
on fact.new_camp_id=camp.new_camp_id;

select * from gcrm.SMS12_4 as a where a.campaign_type <> 'Camps & Events';

--no need to run this
create table fact_camp_events as
select * from fact_contact_camptype
where campaign_type = 'Camps & Events';

--Excluding extreme RO values based on the car model and RO value
--Creating SMS12_5 with model column, 2443710
create table gcrm.SMS12_5 as select a.*, b.model_cd from gcrm.SMS12_4 as a left outer join gcrm.s_asset as b on a.vin = b.asset_num;
--0
delete from gcrm.SMS12_5 as a where a.total_ro_amount >= 200000;
--0
delete from gcrm.SMS12_5 as a where a.total_ro_amount >= 150000 AND a.total_ro_amount < 200000 AND a.model_cd IN ('New Verna','i20','Grand i10','Verna','Xcent','Santro','i10','New i20','Creta','Accent','Sonata','Getz','New Sonata','i20 Active','Eon');
--0
delete from gcrm.SMS12_5 as a where a.total_ro_amount >= 100000 AND a.total_ro_amount < 150000 AND a.model_cd IN ('Grand i10','Xcent','Santro','i10','Accent','Getz','Eon');
--2443710

create table gcrm.sms12_2_count as
select
	a.new_camp_id,
	a.new_campaign_disp_name,
	count(*) as row_count,
	count(a.contact_id) as contact_id,
	count(distinct a.contact_id) as contact_dist,
	count(a.vin) as vin,
	count(distinct a.vin) as vin_dist,
	count(a.total_ro_amount) as totamt_cnt,
	count(nullif(a.total_ro_amount, 0)) as ro_non0_cnt,
	sum(a.total_ro_amount) as total_ro_val
from
	gcrm.sms12_2 as a
group by 1, 2;

-----------------------------------------------------------------------------------------------------------------------------

CREATE TABLE ndms.rcrepm_tb_dedup (
	repm_cmpn_no varchar(1) NULL,
	repm_corp_no varchar(5) NULL,
	repm_dlr_no varchar(10) NULL,
	repm_ro_no varchar(10) NULL,
	repm_vin varchar(17) NULL,
	repm_cust_no varchar(11) NULL,
	repm_ro_stat varchar(2) NULL,
	repm_bkng_no varchar(11) NULL,
	repm_work_type varchar(2) NULL,
	repm_milg numeric(8) NULL,
	repm_estmt_amt numeric(15,2) NULL,
	repm_estmt_prmsn_yn varchar(1) NULL,
	repm_work_fnsh_estmt_dtime timestamp NULL,
	repm_work_fnsh_sys_dtime timestamp NULL,
	repm_work_fnsh_actl_dtime timestamp NULL,
	repm_ro_dtime timestamp NULL,
	repm_svc_advsr_emp_no varchar(10) NULL,
	repm_tchn_emp_no varchar(10) NULL,
	repm_bill_total_part_amt numeric(15,2) NULL,
	repm_bill_total_labr_amt numeric(15,2) NULL,
	repm_bill_total_othr_amt numeric(15,2) NULL,
	repm_clse_dtime timestamp NULL,
	repm_crte_dtime timestamp NULL,
	repm_updt_dtime timestamp NULL,
	repm_ropn_cnt numeric(15) NULL,
	repm_wa_flag varchar(1) NULL
);

ALTER TABLE ndms.rcrepm_tb_dedup OWNER TO postgres;
GRANT ALL ON TABLE ndms.rcrepm_tb_dedup TO postgres;

--------------------------------------------------------------------------------------------------
create table gcrm.sms_only1 as select a.old_camp_id, a.new_camp_id, a.new_campaign_disp_name, a.per_id as contact_id, a.asset_id, a.asset_num as vin, a.prog_start_dt_new, a.prog_end_dt_new, a.channel_clubbed from gcrm.sms_cont_vin_7 as a where a.channel_clubbed = 'SMS only';
create table gcrm.sms_only1_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.sms_only1 as a group by 1, 2;
create table gcrm.sms_only2 as select distinct b.new_camp_id, b.new_campaign_disp_name,	b.contact_id, b.asset_id, b.vin, b.prog_start_dt_new, b.prog_end_dt_new, b.channel_clubbed from gcrm.sms_only1 as b where contact_id is not null;
create table gcrm.sms_only2_count as select a.new_camp_id, a.new_campaign_disp_name, count(*) as row_count, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.sms_only2 as a group by 1, 2;


create table gcrm.both_details_count as select a.new_camp_id, a.new_campaign_disp_name, count(a.contact_id) as contact_id, count(distinct a.contact_id) as contact_dist, count(a.asset_id) as asset_id, count(distinct a.asset_id) as asset_dist, count(a.vin) as vin, count(distinct a.vin) as vin_dist from gcrm.both_details as a group by 1, 2;
create table gcrm.both_details3 as select distinct a.*,	1 as email_ind from gcrm.both_details2 as a left outer join gcrm.most_final_fact_email as b on a.new_camp_id = b.new_camp_id and a.contact_id = a.contact_id;
create table gcrm.both_details4 as select distinct a.*, 1 as sms_ind from gcrm.both_details3 as a left outer join gcrm.most_final_fact_sms as b on a.new_camp_id = b.new_camp_id and a.contact_id = a.contact_id;



select count(*), count(repm_bill_total_labr_amt), count(repm_bill_total_othr_amt), count(repm_bill_total_part_amt) from gcrm.ser_rcrepm_tb_4yr;

-----------------------------------------------------------------------------------------------------------------------------------

copy gcrm.ser_rcrepm_tb_4yr from 'D:/ro_2016/COntact_master.csv' delimiter ',' quote '"' csv header;
copy gcrm.ser_rcrepm_tb_4yr from 'D:/ro_2016/COntact_master_2.csv' delimiter ',' quote '"' csv;
copy gcrm.ser_rcrepm_tb_4yr from 'D:/ro_2016/COntact_master_3.csv' delimiter ',' quote '"' csv;


CREATE TABLE gcrm.final_model_1 (
              new_campaign_disp_name varchar(100) NULL,
              new_camp_id varchar(20) NULL,
              vin varchar(100) NULL,
              channel_clubbed varchar(20) NULL,
              asset_id varchar(15) NULL,
              contact_id varchar(15) NULL,
              prog_start_dt_new timestamp NULL,
              prog_end_dt_new timestamp NULL,
              total_ro_amount numeric NULL,
              ro_count int8 NULL,
              bin_ro int4 NULL,
              ind_rr int4 NULL,
              ind_ps int4 NULL,
              ind_fs int4 NULL,
              rr_count int8 NULL,
              ps_count int8 NULL,
              fs_count int8 NULL,
              con_cd varchar(30) NULL,
              sex_mf varchar(30) NULL,
              city_code varchar(50) NULL,
              campaign_type varchar(20) NULL,
              model_cd varchar(30) NULL,
              ro_dealer varchar(10) NULL,
              repm_ro_no varchar(10) NULL,
              repm_milg numeric(8) NULL,
              max_ro_dtime timestamp NULL,
              ro_state varchar(200) NULL,
              ro_region varchar(20) NULL,
              ro_zone varchar(20) NULL,
              active_from timestamp NULL,
              alias_name varchar(100) NULL,
              model_yr numeric(10) NULL,
              fuel_cd varchar(30) NULL,
              ext_color_cd varchar(30) NULL,
              warranty_start_dt timestamp NULL,
              warranty_end_dt timestamp NULL,
              dlr_id varchar(15) NULL,
              registered_dt timestamp NULL,
              ageofvehicle_targeted varchar(20) NULL,
              models_targeted varchar(50) NULL,
              camp_sub_type varchar(20) NULL,
              frequency varchar(20) NULL,
              region varchar(75) NULL,
              sms_sent numeric(15,2) NULL,
              budget numeric(15,2) NULL,
              city varchar(100) NULL,
              statecode varchar(30) NULL,
              state varchar(50) NULL,
              region_new varchar(30) NULL,
              "zone" varchar(30) NULL,
              cust_group varchar(15) NULL,
              labels varchar(15) NULL
);

copy gcrm.final_model_1 from 'D:/Aravindh/FINAL_GROUP/final_model_1_201912200839.csv' delimiter ',' quote '"' csv header;

-------------------------------------------------------------------------------------------------------------------------



